<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>虫子个人博客</title>
  
  
  <link href="https://wqblogs.com/atom.xml" rel="self"/>
  
  <link href="https://wqblogs.com/"/>
  <updated>2023-06-24T15:59:29.000Z</updated>
  <id>https://wqblogs.com/</id>
  
  <author>
    <name>chongzi</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ubuntu20.04 lts 部署k8s集群</title>
    <link href="https://wqblogs.com/2022/12/30/ubuntu20.04-lts%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/"/>
    <id>https://wqblogs.com/2022/12/30/ubuntu20.04-lts%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/</id>
    <published>2022-12-30T13:11:59.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>关闭防火墙</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ufw <span class="built_in">disable</span> &amp;&amp; sudo ufw stop</span></span><br></pre></td></tr></table></figure><p><strong>关闭swap</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">swapoff -a</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span></span><br></pre></td></tr></table></figure><p><strong>关闭selinux</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">setenforce 0</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sed -i <span class="string">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config</span></span><br></pre></td></tr></table></figure><p><strong>调整内核参数</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/sysctl.d/kubernetes.conf &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">vm.swappiness=0         # 禁止使用 swap 空间，只有当系统 OOM 时才允许使用它</span><br><span class="line">vm.overcommit_memory=1  # 表示内核允许分配所有的物理内存，而不管当前的内存状态如何</span><br><span class="line">vm.panic_on_oom=0       # 表示当内存耗尽时，内核会触发OOM killer杀掉最耗内存的进程</span><br><span class="line">vm.max_map_count=262144  </span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">net.ipv4.tcp_wmem=4096 12582912 16777216</span><br><span class="line">net.ipv4.tcp_rmem=4096 12582912 16777216</span><br><span class="line">net.ipv4.tcp_max_syn_backlog=8096</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle=0</span><br><span class="line">net.ipv4.tcp_tw_reuse=1</span><br><span class="line">net.core.somaxconn=32768</span><br><span class="line">net.core.wmem_max=26214400</span><br><span class="line">net.core.rmem_max=26214400</span><br><span class="line">net.core.rmem_default=26214400</span><br><span class="line">net.core.netdev_max_backlog=16384</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=8000</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2=9000</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3=10000</span><br><span class="line">net.ipv4.conf.default.promote_secondaries=1</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">fs.inotify.max_user_watches=1048576</span><br><span class="line">fs.inotify.max_user_instances=8192</span><br><span class="line">fs.inotify.max_queued_events=16384</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">kernel.pid_max=196608</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">sysctl -p /etc/sysctl.d/kubernetes.conf</span></span></span><br></pre></td></tr></table></figure><p><strong>安装ipset和ipvsadm</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt install -y ipset ipvsadm</span></span><br></pre></td></tr></table></figure><p><strong>配置加载模块</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>临时加载</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">modprobe -- ip_vs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">modprobe -- ip_vs_sh</span></span><br></pre></td></tr></table></figure><p><strong>开机加载配置，将ipvs相关模块加入配置文件中</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt;&gt; /etc/modules &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs</span><br><span class="line">nf_conntrack</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>安装docker-ce</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get install docker.io</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker version</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemcd <span class="built_in">enable</span> docker</span></span><br></pre></td></tr></table></figure><p><strong>生成默认docker配置</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;192.168.0.200&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>  <span class="comment">// 私有仓库</span></span><br><span class="line"> <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://djbk5ums.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">//国内加速镜像</span></span><br><span class="line"> <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20m&quot;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"> <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>配置阿里云镜像站点</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>安装kubeadm、kubelet、kubectl</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get install -y kubelet=1.22.10-00 kubeadm=1.22.10-00 kubectl=1.22.10-00</span><br></pre></td></tr></table></figure><p><strong>使用国内阿里云镜像站点，查看所需镜像</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubeadm config images list \</span></span><br><span class="line"><span class="language-bash">--image-repository registry.aliyuncs.com/google_containers \</span></span><br><span class="line"><span class="language-bash">--kubernetes-version=v1.22.10</span></span><br></pre></td></tr></table></figure><p><strong>指定版本下载</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubeadm config images pull \</span></span><br><span class="line"><span class="language-bash">--kubernetes-version=v1.22.10 \</span></span><br><span class="line"><span class="language-bash">--image-repository registry.aliyuncs.com/google_containers</span></span><br></pre></td></tr></table></figure><p><strong>初始化配置文件</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubeadm</span> <span class="string">config</span> <span class="string">print</span> <span class="string">init-defaults</span> <span class="string">&gt;</span> <span class="string">kubeadm-config.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">vi</span> <span class="string">kubeadm-config.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span>    <span class="comment"># 配置初始化master节点ip</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master</span>                       <span class="comment"># 配置初始化master节点主机名</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span> <span class="comment"># 指定国内源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.22</span><span class="number">.10</span>           <span class="comment"># 指定版本</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 使用ipvs</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 指定cgroup</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br></pre></td></tr></table></figure><p><strong>初始化master节点</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubeadm init --config=kubeadm-config.yaml --upload-certs| <span class="built_in">tee</span> kubeadm-init.log</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;关闭防火墙&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta prompt_&quot;</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>multipss尝鲜</title>
    <link href="https://wqblogs.com/2022/12/30/multipass%E9%85%8D%E7%BD%AE%E8%99%9A%E6%9C%BA/"/>
    <id>https://wqblogs.com/2022/12/30/multipass%E9%85%8D%E7%BD%AE%E8%99%9A%E6%9C%BA/</id>
    <published>2022-12-30T08:00:59.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>查看可下载的Ubuntu镜像</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass find</span></span><br><span class="line">Image                       Aliases           Version          Description</span><br><span class="line">core                        core16            20200818         Ubuntu Core 16</span><br><span class="line">core18                                        20211124         Ubuntu Core 18</span><br><span class="line">snapcraft:core18            18.04             20201111         Snapcraft builder for Core 18</span><br><span class="line">snapcraft:core20            20.04             20210921         Snapcraft builder for Core 20</span><br><span class="line">snapcraft:core22            22.04             20220426         Snapcraft builder for Core 22</span><br><span class="line">18.04                       bionic            20221207         Ubuntu 18.04 LTS</span><br><span class="line">20.04                       focal             20221213         Ubuntu 20.04 LTS</span><br><span class="line">22.04                       jammy,lts         20221214         Ubuntu 22.04 LTS</span><br><span class="line">appliance:adguard-home                        20200812         Ubuntu AdGuard Home Appliance</span><br><span class="line">appliance:mosquitto                           20200812         Ubuntu Mosquitto Appliance</span><br><span class="line">appliance:nextcloud                           20200812         Ubuntu Nextcloud Appliance</span><br><span class="line">appliance:openhab                             20200812         Ubuntu openHAB Home Appliance</span><br><span class="line">appliance:plexmediaserver                     20200812         Ubuntu Plex Media Server Appliance</span><br><span class="line">anbox-cloud-appliance                         latest           Anbox Cloud Appliance</span><br><span class="line">charm-dev                                     latest           A development and testing environment for charmers</span><br><span class="line">docker                                        latest           A Docker environment with Portainer and related tools</span><br><span class="line">jellyfin                                      latest           Jellyfin is a Free Software Media System that puts you in control of managing and streaming your media.</span><br><span class="line">minikube                                      latest           minikube is local Kubernetes</span><br></pre></td></tr></table></figure><p>创建虚拟机</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass launch focal -n vm01 -c 1 -m 1G -d 10G</span></span><br></pre></td></tr></table></figure><p>自定义配置</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">focal，别名：20.04</span><br><span class="line">-n, --name: 名称</span><br><span class="line">-c, --cpus: cpu核心数, 默认: 1</span><br><span class="line">-m, --mem: 内存大小, 默认: 1G</span><br><span class="line">-d, --disk: 硬盘大小, 默认: 5G</span><br></pre></td></tr></table></figure><p>查看虚拟机列表</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass list</span></span><br><span class="line">Name                    State             IPv4             Image</span><br><span class="line">vm01                    Running           172.22.76.182    Ubuntu 20.04 LTS</span><br></pre></td></tr></table></figure><p>查看虚拟机信息</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass info vm01</span></span><br><span class="line">Name:           vm01</span><br><span class="line">State:          Running</span><br><span class="line">IPv4:           172.22.76.182</span><br><span class="line">Release:        Ubuntu 20.04.5 LTS</span><br><span class="line">Image hash:     1bf86f40534c (Ubuntu 20.04 LTS)</span><br><span class="line">Load:           0.00 0.00 0.00</span><br><span class="line">Disk usage:     1.4G out of 9.5G</span><br><span class="line">Memory usage:   175.4M out of 911.9M</span><br><span class="line">Mounts:         --</span><br></pre></td></tr></table></figure><p>外部操作虚拟机</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass <span class="built_in">exec</span> vm01 ip add</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:da:af:b9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.22.76.182/20 brd 172.22.79.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 85443sec preferred_lft 85443sec</span><br><span class="line">    inet6 fe80::5054:ff:feda:afb9/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>进入虚拟机</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">multipass.exe shell vm01</span></span><br><span class="line">Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-135-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Tue Dec 27 11:35:07 CST 2022</span><br><span class="line"></span><br><span class="line">  System load:  0.0               Processes:             105</span><br><span class="line">  Usage of /:   15.2% of 9.51GB   Users logged in:       0</span><br><span class="line">  Memory usage: 26%               IPv4 address for eth0: 172.22.76.182</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"> * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s</span><br><span class="line">   just raised the bar for easy, resilient and secure K8s cluster deployment.</span><br><span class="line"></span><br><span class="line">   https://ubuntu.com/engage/secure-kubernetes-at-the-edge</span><br><span class="line"></span><br><span class="line">0 updates can be applied immediately.</span><br><span class="line"></span><br><span class="line">New release &#x27;22.04.1 LTS&#x27; available.</span><br><span class="line">Run &#x27;do-release-upgrade&#x27; to upgrade to it.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Tue Dec 27 11:32:15 2022 from 172.22.64.1</span><br><span class="line">ubuntu@vm01:~$</span><br></pre></td></tr></table></figure><p>删除虚机并释放</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭虚机</span></span><br><span class="line">multipass stop vm01</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除虚机</span></span><br><span class="line">multipass delete vm01</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">释放虚机</span></span><br><span class="line">multipass purge</span><br></pre></td></tr></table></figure><p><a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">虚机预配置</a></p><p>使用–cloud-init 选项就行虚机启动初始化配置，下列<strong>yaml</strong> 则是容器的初始化配置文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cloud-config</span></span><br><span class="line">apt:</span><br><span class="line">  primary:</span><br><span class="line">    - arches: [default]</span><br><span class="line">      uri: http://mirrors.aliyun.com/ubuntu/</span><br><span class="line">runcmd:</span><br><span class="line">  - sudo swapoff -a</span><br><span class="line">  - sudo sed -i &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab</span><br><span class="line">  - sudo setenforce 0</span><br><span class="line">  - sudo sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line">  - sudo systemctl disable ufw &amp;&amp; sudo systemctl stop ufw</span><br><span class="line">  - sudo timedatectl set-timezone Asia/Shanghai</span><br><span class="line">  - sudo echo &quot;PermitRootLogin yes&quot; &gt;&gt; /etc/ssh/sshd_config</span><br><span class="line">  - sudo sed -i &quot;s/PasswordAuthentication no/PasswordAuthentication yes/&quot;  /etc/ssh/sshd_config</span><br><span class="line">  - sudo systemctl restart ssh</span><br></pre></td></tr></table></figure><p><code>apt</code>配置虚机主apt存储库</p><p><code>runcmd</code> 可以指定虚机首次启动时运行的命令</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">multipass launch focal -n node01 -c 2 -m 4G -d 50G --cloud-init systemd-init.yaml</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;查看可下载的Ubuntu镜像&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta prompt_&quot;&gt;$ &lt;/spa</summary>
      
    
    
    
    <category term="无聊操作" scheme="https://wqblogs.com/categories/%E6%97%A0%E8%81%8A%E6%93%8D%E4%BD%9C/"/>
    
    
    <category term="multipass" scheme="https://wqblogs.com/tags/multipass/"/>
    
  </entry>
  
  <entry>
    <title>postgresql生产事故</title>
    <link href="https://wqblogs.com/2022/11/27/postgresql%E7%94%9F%E4%BA%A7%E4%BA%8B%E6%95%85/"/>
    <id>https://wqblogs.com/2022/11/27/postgresql%E7%94%9F%E4%BA%A7%E4%BA%8B%E6%95%85/</id>
    <published>2022-11-27T13:16:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="postgresql生产事故"><a href="#postgresql生产事故" class="headerlink" title="postgresql生产事故"></a>postgresql生产事故</h2><h3 id="事故概要"><a href="#事故概要" class="headerlink" title="事故概要"></a>事故概要</h3><p>环境：</p><ul><li><p>底层环境为：K8s + Docker</p></li><li><p>部署方式：Operator + StatefulSet</p></li></ul><p>现象：</p><p>通过远程工具方式连接<code>pooler</code>：<code>ERROR: client_login_timeout(server down) ERROR: SSL required</code></p><p>通过master终端连接 <code>psql -hxxxx -Upostgres -dpostgres</code>：发现执行夯住</p><p>查看pooler日志： <code>postgres/postgres@xxxx:49696 pooler error: pgbouncer cannot connect to server</code></p><h3 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h3><ul><li>测试通过pooler pod终端连接</li></ul><p>通过客户端使用pooler地址链接发现超时，然后通过终端方式连接master，发现夯住，排除了pod 网络及端口。</p><ul><li>测试通过master pod终端连接</li></ul><p>通过终端方式直联master，发现夯住，然后通过top命令发现cpu负载500以上，执行<code>patronictl list</code>查看集群状态也是夯住</p><ul><li>通过slave pod终端查看集群状态<br>Patroni是一个基于Python的开源PostgreSQL模板和控制器，运行高可用性Postgres集群。可以通过patronictl查看集群状态、重启加载集群、移除集群、切换Leader等操作。</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patronictl list</span></span><br><span class="line">+ Cluster: gismip-postgresql (7026907782262050884) -------+----+-----------+-----------------+</span><br><span class="line">| Member | Host | Role | State | TL | Lag in MB | Pending restart |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br><span class="line">| gismip-postgresql-0 | 172.28.188.75 | Leader | running | 40 | 0 | * |</span><br><span class="line">| gismip-postgresql-1 | 172.28.27.38 | Replica | running | 40 | 0| * |</span><br><span class="line">| gismip-postgresql-2 | 172.28.0.22 | Replica | running | 27 | 39587 | * |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br></pre></td></tr></table></figure><p>发现TL(timeline 时间线)不一致并且postgresql-2副本有小4个GB延迟</p><h3 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h3><ul><li>手动干预主从，切换主从</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patronictl switchover</span></span><br><span class="line">Master [gismip-postgresql-0]: # 回车，确认当前leader</span><br><span class="line">Candidate [&#x27;gismip-postgresql-1&#x27;, &#x27;gismip-postgresql-2&#x27;] []: gismip-postgresql-1 # 手动配置主，把slave写入 回车</span><br><span class="line">When should the switchover take place (e.g. 2022-11-27T20:37 ) [now]: # 回车切换</span><br></pre></td></tr></table></figure><ul><li>初始化postgresql-2节点,一般有延迟或者副本异常运行时，可以使用此方法初始化节点信息以重新加入集群</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patronictl reinit gismip-postgresql gismip-postgresql-2</span></span><br><span class="line">+ Cluster: gismip-postgresql (7026907782262050884) -------+----+-----------+-----------------+</span><br><span class="line">| Member | Host | Role | State | TL | Lag in MB | Pending restart |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br><span class="line">| gismip-postgresql-0 | 172.28.188.75 | Replica | running | 40 | 0 | * |</span><br><span class="line">| gismip-postgresql-1 | 172.28.27.38 | Leader | running | 40 | | * |</span><br><span class="line">| gismip-postgresql-2 | 172.28.0.22 | Replica | running | 27 | 39587 | * |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br><span class="line">Are you sure you want to reinitialize members gismip-postgresql-2? [y/N]: # 输入Y 确认重新初始化数据</span><br></pre></td></tr></table></figure><ul><li>查看集群状态，集群已正常</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">patronictl list</span></span><br><span class="line">+ Cluster: gismip-postgresql (7026907782262050884) -------+----+-----------+-----------------+</span><br><span class="line">| Member              |      Host     |   Role  |  State  | TL | Lag in MB | Pending restart |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br><span class="line">| gismip-postgresql-0 | 172.28.188.75 | Replica | running | 40 |         0 |        *        |</span><br><span class="line">| gismip-postgresql-1 |  172.28.27.38 |  Leader | running | 40 |           |        *        |</span><br><span class="line">| gismip-postgresql-2 |  172.28.0.22  | Replica | running | 40 |         0 |        *        |</span><br><span class="line">+---------------------+---------------+---------+---------+----+-----------+-----------------+</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;postgresql生产事故&quot;&gt;&lt;a href=&quot;#postgresql生产事故&quot; class=&quot;headerlink&quot; title=&quot;postgresql生产事故&quot;&gt;&lt;/a&gt;postgresql生产事故&lt;/h2&gt;&lt;h3 id=&quot;事故概要&quot;&gt;&lt;a href=&quot;#事</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="postgresql" scheme="https://wqblogs.com/categories/Kubernetes/postgresql/"/>
    
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
    <category term="postgresql" scheme="https://wqblogs.com/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>GO语言变量及常量</title>
    <link href="https://wqblogs.com/2022/11/24/go%E8%AF%AD%E8%A8%80%E5%8F%98%E9%87%8F%E5%8F%8A%E5%B8%B8%E9%87%8F/"/>
    <id>https://wqblogs.com/2022/11/24/go%E8%AF%AD%E8%A8%80%E5%8F%98%E9%87%8F%E5%8F%8A%E5%B8%B8%E9%87%8F/</id>
    <published>2022-11-24T11:45:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="GO语言变量及常量"><a href="#GO语言变量及常量" class="headerlink" title="GO语言变量及常量"></a>GO语言变量及常量</h2><h3 id="golang变量"><a href="#golang变量" class="headerlink" title="golang变量"></a>golang变量</h3><p> 变量是计算机语言中能<strong>储存</strong>计算结果或能表示值的抽象概念。不同的变量保存的<strong>数据类型</strong>可能会不一样。</p><h4 id="声明变量"><a href="#声明变量" class="headerlink" title="声明变量"></a>声明变量</h4><p>Go语言中的变量需要声明后才能使用，同一作用域内不支持重复声明。 并且Go语言的变量声明后必须使用。</p><p><strong>声明变量的语法</strong></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> identifier <span class="keyword">type</span></span><br></pre></td></tr></table></figure><p><code>var</code>：声明变量关键字  </p><p><code>identifier</code>：变量名称 </p><p><code>type</code>：变量类型</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line">    <span class="keyword">var</span> age <span class="type">int</span></span><br><span class="line">    <span class="keyword">var</span> ok <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>批量声明</strong></p><p>使用一个<code>var</code>关键字，把一些变量写在一个括号<code>()</code>里</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        name <span class="type">string</span></span><br><span class="line">        age <span class="type">int</span></span><br><span class="line">        ok <span class="type">bool</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="变量的初始化"><a href="#变量的初始化" class="headerlink" title="变量的初始化"></a>变量的初始化</h4><p>Go语言在声明变量的时候，会自动对变量对应的内存区域进行初始化操作。每个变量会被初始化成其类型的默认值，例如： 整型和浮点型变量的默认值为<code>0</code>。 字符串变量的默认值为空字符串“”。 布尔型变量默认为<code>false</code>。 切片、函数、指针变量的默认为<code>nil</code>。</p><p>变量初始化语法  </p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> 变量名 类型 =</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        name    <span class="type">string</span> = <span class="string">&quot;虫子&quot;</span></span><br><span class="line">        address <span class="type">string</span> = <span class="string">&quot;wqblogs.com:4443&quot;</span></span><br><span class="line">    )</span><br><span class="line">    fmt.Printf(<span class="string">&quot;name: %v\n&quot;</span>, name)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;address: %v\n&quot;</span>, address)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>类型推导</strong></p><p>我们在声明变量时，可以根据初始化值进行类型推导，从而省略类型。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;虫子&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age = <span class="number">27</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>初始化多个变量</strong></p><p>可以一次初始化多个变量，中间用逗号分隔。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name,age,b =<span class="string">&quot;虫子&quot;</span>,<span class="number">27</span>,<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="短变量声明"><a href="#短变量声明" class="headerlink" title="短变量声明"></a>短变量声明</h4><p>只能在函数内部使用，可以使用<code>:=</code>运算符对变量进行声明和初始化。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    name := <span class="string">&quot;虫子&quot;</span></span><br><span class="line">    age := <span class="number">27</span></span><br><span class="line">    a := <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="匿名变量"><a href="#匿名变量" class="headerlink" title="匿名变量"></a>匿名变量</h4><p>如果我们接收到多个变量，有一些变量使用不到，可以使用下划线_表示变量名称，这种变量叫做匿名变量。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNameAndAge</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">int</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;虫子&quot;</span>, <span class="number">27</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _, age := getNameAndAge()</span><br><span class="line">    <span class="comment">// fmt.Printf(&quot;name: %v\n&quot;, name)</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;age: %v\n&quot;</span>, age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="golang常量"><a href="#golang常量" class="headerlink" title="golang常量"></a>golang常量</h3><p>常量，就是在程序<strong>编译阶段</strong>就确定下来的值，而程序在<strong>运行时</strong>则无法改变该值。在Go程序中，常量可以是数值类型（包括整型、浮点型和复数类型）、布尔类型、字符串类型等。</p><h4 id="定义常量的语法"><a href="#定义常量的语法" class="headerlink" title="定义常量的语法"></a>定义常量的语法</h4><p>定义一个常量使用const关键字，语法格式如下</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> constantName [<span class="keyword">type</span>]= value</span><br></pre></td></tr></table></figure><p><code>const</code>  ：定义常量关键字</p><p><code>constantName</code>  ：常量名称</p><p><code>type</code>  ：常量类型</p><p><code>value</code>  ：常量的值</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> PI <span class="type">float64</span> = <span class="number">3.14</span></span><br><span class="line"><span class="keyword">const</span> PI2 = <span class="number">3.1415</span> <span class="comment">// 可以省略类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">width  = <span class="number">100</span></span><br><span class="line">height = <span class="number">200</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> i, j = <span class="number">1</span>, <span class="number">2</span> <span class="comment">// 多重赋值</span></span><br><span class="line"><span class="keyword">const</span> a, b, c = <span class="number">1</span>, <span class="number">2</span>, <span class="string">&quot;foo&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>iota</strong></p><p>iota 比较特殊，可以被认为是一个可被编译器修改的常量，它默认开始值是<code>0</code>  ，每调用一次加<code>1</code>  。遇到 <code>const</code>  关键字时被重置为 <code>0</code>。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">a1 = <span class="literal">iota</span></span><br><span class="line">a2 = <span class="literal">iota</span></span><br><span class="line">a3 = <span class="literal">iota</span></span><br><span class="line">)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a1: %v\n&quot;</span>, a1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a2: %v\n&quot;</span>, a2)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a3: %v\n&quot;</span>, a3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回值</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">a1: <span class="number">0</span></span><br><span class="line">a2: <span class="number">1</span></span><br><span class="line">a3: <span class="number">2</span></span><br></pre></td></tr></table></figure><p><strong>使用<code>_</code> 跳过某些值</strong></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">a1 = <span class="literal">iota</span></span><br><span class="line">_</span><br><span class="line">a3 = <span class="literal">iota</span></span><br><span class="line">)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a1: %v\n&quot;</span>, a1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a3: %v\n&quot;</span>, a3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回值</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">a1: <span class="number">0</span></span><br><span class="line">a3: <span class="number">2</span></span><br></pre></td></tr></table></figure><p><strong><code>iota</code>  声明中间插队</strong></p><p>效果与 <code>_</code>类似</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">a1 = <span class="literal">iota</span></span><br><span class="line">a2 = <span class="number">100</span></span><br><span class="line">a3 = <span class="literal">iota</span></span><br><span class="line">)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a1: %v\n&quot;</span>, a1)</span><br><span class="line">fmt.Printf(<span class="string">&quot;a3: %v\n&quot;</span>, a3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回值</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">a1: <span class="number">0</span></span><br><span class="line">a2: <span class="number">100</span></span><br><span class="line">a3: <span class="number">2</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;GO语言变量及常量&quot;&gt;&lt;a href=&quot;#GO语言变量及常量&quot; class=&quot;headerlink&quot; title=&quot;GO语言变量及常量&quot;&gt;&lt;/a&gt;GO语言变量及常量&lt;/h2&gt;&lt;h3 id=&quot;golang变量&quot;&gt;&lt;a href=&quot;#golang变量&quot; class=&quot;</summary>
      
    
    
    
    <category term="Go语言" scheme="https://wqblogs.com/categories/Go%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Go语言" scheme="https://wqblogs.com/tags/Go%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>如何编写golang代码</title>
    <link href="https://wqblogs.com/2022/11/23/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99golang%E4%BB%A3%E7%A0%81/"/>
    <id>https://wqblogs.com/2022/11/23/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99golang%E4%BB%A3%E7%A0%81/</id>
    <published>2022-11-23T15:19:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="如何编写golang代码"><a href="#如何编写golang代码" class="headerlink" title="如何编写golang代码"></a>如何编写golang代码</h2><h3 id="代码组织"><a href="#代码组织" class="headerlink" title="代码组织"></a>代码组织</h3><p>go应用使用包和模块来组织代码，包对应到文件系统就是文件夹，模块就是**.go的go源文件。一个包会有多个模块，或者多个子包。</p><h3 id="go-项目管理工具"><a href="#go-项目管理工具" class="headerlink" title="go 项目管理工具"></a>go 项目管理工具</h3><p>早期的go项目使用gopath来管理项目，不方便而且容易出错，从golang 1.11开始使用gomod管理项目，当然还有第三方模块例如govendor，这里介绍gomod的使用</p><h3 id="创建程序步骤"><a href="#创建程序步骤" class="headerlink" title="创建程序步骤"></a>创建程序步骤</h3><ul><li><p>创建项目</p></li><li><p>初始化项目</p></li><li><p>创建包</p></li><li><p>创建模块</p></li><li><p>相互调用</p></li></ul><h3 id="golang标识符、关键字、命名规则"><a href="#golang标识符、关键字、命名规则" class="headerlink" title="golang标识符、关键字、命名规则"></a>golang标识符、关键字、命名规则</h3><h4 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h4><p>标识符：通俗来说，就是给变量、常量、函数、方法、结构体、数组、切片、接口起名字</p><p>标识符的组成</p><ol><li><p>标识符由数字、字母和下划线组成。123 abc _</p></li><li><p>只能以字母和下划线开头。abc123 _abc</p></li><li><p>标识符区分大小写</p></li><li><p>go语言关键字，不能用于定义名字</p></li></ol><table><thead><tr><th>append</th><th>default</th><th>func</th><th>interface</th><th>select</th></tr></thead><tbody><tr><td>case</td><td>defer</td><td>go</td><td>map</td><td>struct</td></tr><tr><td>chan</td><td>else</td><td>goto</td><td>package</td><td>switch</td></tr><tr><td>const</td><td>fallthrough</td><td>if</td><td>range</td><td>type</td></tr><tr><td>continue</td><td>for</td><td>import</td><td>return</td><td>var</td></tr></tbody></table><p>除了以上构建字，Go语言还有30多个标识符，其中包含了基本类型的名称和内置函数</p><p>常量:</p><p>    true false iota nil<br>内置基本类型:<br>    int int8 int16 int32 int64<br>    uint uint8 uint16 uint32 uint64 uintptr<br>    float32 float64 complex128 complex64<br>    bool byte rune string error<br>内置函数:<br>    make len cap new append copy close delete<br>    complex real imag<br>    panic recover print println</p><h4 id="Go中的命名规范"><a href="#Go中的命名规范" class="headerlink" title="Go中的命名规范"></a>Go中的命名规范</h4><p><strong>Go语言是一门区分大小写的语言</strong></p><p>命名规则涉及变量、常量、全局函数、结构、接口、方法等的命名。Go语言从语法从面进行了一下限定：任何需要对外暴露的名字必须一大写字母开头，不需要对外暴露的则应该已小写字母开头。</p><p>当命名（变量、常量、全局函数、结构、接口、方法等）已一个大写字母开头，如：<code>GetUserName</code>，那么使用这种形式的标识符的对象就<strong>可以被外部包代码所使用</strong>（客户端程序需要先导入这个包），这就称为导出（像面向对象语言中的<code>pubilc</code>）；<strong>命名如果以小写字母开头，则对包是不可见的，但是他们在整个包内部是可见可用的</strong>（像面向对象语言中的<code>private</code>）。</p><p><strong>包名称</strong></p><p>保持<code>package</code>的名字与目录保持一致，尽量采取有意义的包名，尽量和标准库不要冲突，包名应该为<strong>小写</strong>单词，不要使用下划线或者混合大小写。</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br></pre></td></tr></table></figure><p><strong>文件命名</strong></p><p>尽量采取有意义的文件名，应该为<strong>小写</strong>单词，使用<strong>下划线</strong>分隔给个单词。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">web_service.go</span><br></pre></td></tr></table></figure><p><strong>结构体命名</strong></p><p>采用<strong>驼峰命名法</strong>，首字母根据访问控制大写或者小写</p><p>struct 申明和初始化格式采用多行，例如下面：</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> CustomerOrder <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Address <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">oder := CustomerOrder&#123;<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;北京海淀&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p><strong>接口命名</strong></p><p>命名规则基本和上面的结构体类似</p><p>单个函数的结构名以 “er” 作为后缀，例如 Reader , Writer </p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">     Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>变量命名</strong></p><p>和结构体类似，变量名称一般遵循驼峰法，首字母根据访问控制原则大写或者小写，但遇到特有名词时，需要遵循以下规则：</p><p>如果变量为私有，且特有名词为首个单词，则使用小写，如 appService若变量类型为 bool 类型，则名称应以 Has, Is, Can 或 Allow 开头</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> isExist <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> hasConflict <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> canManage <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> allowGitHook <span class="type">bool</span></span><br></pre></td></tr></table></figure><p><strong>常量</strong></p><p>常量均需使用全部大写字母组成，并使用下划线分词</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> APP_URL = <span class="string">&quot;https://www.baidu.com&quot;</span></span><br></pre></td></tr></table></figure><p><strong>错误处理</strong></p><p>错误处理的原则就是不能丢弃任何有返回err的调用，不要使用 _ 丢弃，必须全部处理。接收到错误，要么返回err，或者使用log记录下来尽早return：一旦有错误发生，马上返回尽量不要使用panic，除非你知道你在做什么错误描述如果是英文必须为小写，不需要标点结尾采用独立的错误流进行处理</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// normal code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确写法</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// or continue, etc.</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// normal code</span></span><br></pre></td></tr></table></figure><p><strong>单元测试</strong></p><p>单元测试文件名命名规范为 example_test.go 测试用例的函数名称必须以 Test 开头，例如：TestExample 每个重要的函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试 。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;如何编写golang代码&quot;&gt;&lt;a href=&quot;#如何编写golang代码&quot; class=&quot;headerlink&quot; title=&quot;如何编写golang代码&quot;&gt;&lt;/a&gt;如何编写golang代码&lt;/h2&gt;&lt;h3 id=&quot;代码组织&quot;&gt;&lt;a href=&quot;#代码组织&quot; cla</summary>
      
    
    
    
    <category term="Go语言" scheme="https://wqblogs.com/categories/Go%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Go语言" scheme="https://wqblogs.com/tags/Go%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>Go语言学习目录</title>
    <link href="https://wqblogs.com/2022/11/22/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%9B%AE%E5%BD%95/"/>
    <id>https://wqblogs.com/2022/11/22/Go%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%9B%AE%E5%BD%95/</id>
    <published>2022-11-22T11:45:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<ol><li><a href="https://www.wqblogs.com:4443/2022/11/22/go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">学习go环境配置</a></li><li><a href="https://www.wqblogs.com:4443/2022/11/23/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99golang%E4%BB%A3%E7%A0%81/">如何编写golang代码</a></li><li><a href="https://www.wqblogs.com:4443/2022/11/24/go%E8%AF%AD%E8%A8%80%E5%8F%98%E9%87%8F%E5%8F%8A%E5%B8%B8%E9%87%8F/">GO语言变量及常量</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://www.wqblogs.com:4443/2022/11/22/go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/&quot;&gt;学习go环境配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://ww</summary>
      
    
    
    
    <category term="Go语言" scheme="https://wqblogs.com/categories/Go%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Go语言" scheme="https://wqblogs.com/tags/Go%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>go环境配置</title>
    <link href="https://wqblogs.com/2022/11/22/go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    <id>https://wqblogs.com/2022/11/22/go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</id>
    <published>2022-11-22T11:45:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>golang官网地址：<a href="https://golang.google.cn/">https://golang.google.cn</a></p><p>golang中文文档：<a href="https://studygolang.com/pkgdoc">https://studygolang.com/pkgdoc</a></p><p>golang学习教程：<a href="https://golang-tech-stack.com/tutorial">https://golang-tech-stack.com/tutorial</a></p><h2 id="go-环境配置"><a href="#go-环境配置" class="headerlink" title="go 环境配置"></a>go 环境配置</h2><h3 id="Windows-配置"><a href="#Windows-配置" class="headerlink" title="Windows 配置"></a>Windows 配置</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">go env</span><br></pre></td></tr></table></figure><p>goroot为go安装的根目录，gopath就是go项目所在的路径，高版本go项目已经不在依赖gopath来管理项目，使用go mod来管理项目。</p><p>配置GO111MODULE环境变量</p><p>GO111MODULE 是 Go 1.11 引入的新版模块管理方式。之前的版本中，安装的三方库比如 go-cmp ，要求模块存在于 GOPATH 下，否则编译时会找不到。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启GO111MODULE</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">env</span>:GO111MODULE = <span class="string">&quot;on&quot;</span></span></span><br></pre></td></tr></table></figure><p>配置 <a href="https://goproxy.io/zh/">proxy</a> 环境变量 PowerShell (Windows)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 GOPROXY 环境变量</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">env</span>:GOPROXY = <span class="string">&quot;https://proxy.golang.com.cn,direct&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">还可以设置不走 proxy 的私有仓库或组，多个用逗号相隔（可选）</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">env</span>:GOPRIVATE = <span class="string">&quot;git.mycompany.com,github.com/my/private&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="Vscode-配置"><a href="#Vscode-配置" class="headerlink" title="Vscode 配置"></a>Vscode 配置</h3><p>安装插件</p><p>go                         go环境插件</p><p>code runner       程序运行插件</p><p>常用快捷键</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">ctrl + /         行注释 </span><br><span class="line">shift + alt + a  （可以修改为ctrl + shift + /） 块注释 </span><br><span class="line">ctrl + shift + k 删除行</span><br><span class="line">ctrl + e         查找文件 </span><br><span class="line">ctrl + shift + p 打开设置命令行 </span><br></pre></td></tr></table></figure><p>快速生成代码片段</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">pkgm  main包 + main主函数</span><br><span class="line">ff    fmt.Printf(<span class="string">&quot;&quot;</span>, <span class="keyword">var</span>)</span><br><span class="line"><span class="keyword">for</span>   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;&#125;</span><br><span class="line">forr <span class="keyword">for</span> _, V := <span class="keyword">range</span> v &#123;&#125;</span><br><span class="line">fmain <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">a.<span class="built_in">print</span>! fmt.Printf(<span class="string">&quot;a: %v\n&quot;</span>, a)</span><br></pre></td></tr></table></figure><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>直接在终端中输入<code>go help</code>即可显示所有的go命令以及相应命令功能简介，主要有下面这些：</p><ul><li><p>build: 编译包和依赖</p></li><li><p>clean: 清理已编译的包及对象</p></li><li><p>doc: 显示包或者符号的文档</p></li><li><p>env: 打印go的环境信息</p></li><li><p>bug: 启动错误报告</p></li><li><p>fix: 运行 go tool fix</p></li><li><p>fmt: 运行gofmt进行格式化</p></li><li><p>generate: 从processing source生成go文件</p></li><li><p>get: 下载并安装包和依赖</p></li><li><p>install: 编译并安装包和依赖</p></li><li><p>list: 列出包</p></li><li><p>run: 编译并运行go程序</p></li><li><p>test: 运行测试</p></li><li><p>tool: 运行go提供的工具</p></li><li><p>version: 显示go的版本</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;golang官网地址：&lt;a href=&quot;https://golang.google.cn/&quot;&gt;https://golang.google.cn&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;golang中文文档：&lt;a href=&quot;https://studygolang.com/pkgdoc&quot;&gt;ht</summary>
      
    
    
    
    <category term="Go语言" scheme="https://wqblogs.com/categories/Go%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Go语言" scheme="https://wqblogs.com/tags/Go%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>Java项目配置Nexus</title>
    <link href="https://wqblogs.com/2022/11/03/Java%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AENexus/"/>
    <id>https://wqblogs.com/2022/11/03/Java%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AENexus/</id>
    <published>2022-11-03T11:56:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Java项目引入nexus配置"><a href="#Java项目引入nexus配置" class="headerlink" title="Java项目引入nexus配置"></a>Java项目引入nexus配置</h3><p>POM文件中引入nexus</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置nexus仓库 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Team Nexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://172.22.96.91:18081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span>         </span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置从那个库中下载插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Team Nexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://172.22.96.91:18081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Maven镜像中Mvn-命令配置"><a href="#Maven镜像中Mvn-命令配置" class="headerlink" title="Maven镜像中Mvn 命令配置"></a>Maven镜像中Mvn 命令配置</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27; &gt; settings.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span><br><span class="line">          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;</span><br><span class="line">  &lt;!-- 本地nexus私服认证 --&gt;</span><br><span class="line">  &lt;servers&gt;</span><br><span class="line">      &lt;server&gt;</span><br><span class="line">          &lt;id&gt;nexus-releases&lt;/id&gt;  &lt;!-- 与 pom.xml 里的 repository 上的 ID 对应 --&gt;</span><br><span class="line">          &lt;username&gt;$&#123;username&#125;&lt;/username&gt;</span><br><span class="line">          &lt;password&gt;$&#123;password&#125;&lt;/password&gt;</span><br><span class="line">      &lt;/server&gt;</span><br><span class="line">  &lt;/servers&gt;</span><br><span class="line">  &lt;mirrors&gt;</span><br><span class="line">      &lt;!-- 所有maven下载都通过本地nexus私服 --&gt;</span><br><span class="line">      &lt;mirror&gt;</span><br><span class="line">          &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">          &lt;name&gt;local nexus maven&lt;/name&gt;</span><br><span class="line">          &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">          &lt;url&gt;http://172.22.96.91:18081/repository/maven-public/&lt;/url&gt;</span><br><span class="line">      &lt;/mirror&gt;     </span><br><span class="line">  &lt;/mirrors&gt;  </span><br><span class="line">&lt;/settings&gt;</span><br><span class="line">EOF</span><br><span class="line">  </span><br><span class="line">mvn -Dusername=$NEXUS_USERNAME -Dpassword=$NEXUS_PASSWORD -Dmaven.test.skip=true -DskipDocker -s ./settings.xml clean package</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Java项目引入nexus配置&quot;&gt;&lt;a href=&quot;#Java项目引入nexus配置&quot; class=&quot;headerlink&quot; title=&quot;Java项目引入nexus配置&quot;&gt;&lt;/a&gt;Java项目引入nexus配置&lt;/h3&gt;&lt;p&gt;POM文件中引入nexus&lt;/p&gt;
</summary>
      
    
    
    
    <category term="jenkins" scheme="https://wqblogs.com/categories/jenkins/"/>
    
    <category term="maven" scheme="https://wqblogs.com/categories/jenkins/maven/"/>
    
    
    <category term="jenkins" scheme="https://wqblogs.com/tags/jenkins/"/>
    
    <category term="maven" scheme="https://wqblogs.com/tags/maven/"/>
    
  </entry>
  
  <entry>
    <title>容器运行hexo</title>
    <link href="https://wqblogs.com/2022/05/12/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8Chexo/"/>
    <id>https://wqblogs.com/2022/05/12/%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8Chexo/</id>
    <published>2022-05-12T05:50:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="hexo运行脚本"><a href="#hexo运行脚本" class="headerlink" title="hexo运行脚本"></a>hexo运行脚本</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rm -f hexo </span><br><span class="line">docker run -d --name=hexo --restart always -p 80:4000 \</span><br><span class="line">-v /data/hexo/source:/opt/blog/source \</span><br><span class="line">-v /root/.ssh/id_rsa:/root/.ssh/id_rsa \</span><br><span class="line">-v /data/hexo/_config.yml:/opt/blog/_config.yml \</span><br><span class="line">-v /data/hexo/_config.butterfly.yml:/opt/blog/_config.butterfly.yml \</span><br><span class="line">-v /data/hexo/themes/butterfly/source/img:/opt/blog/themes/butterfly/source/img \</span><br><span class="line">heweiqun/hexo:202205121314-node-12.22.7</span><br></pre></td></tr></table></figure><p>butterfly主题使用：<a href="https://butterfly.js.org/posts/21cfbf15/">Butterfly 安裝文檔</a></p><p>&#x2F;opt&#x2F;blog&#x2F;source                                           本地需要_posts目录才能启动</p><p>&#x2F;root&#x2F;.ssh&#x2F;id_rsa                                           挂载密钥方便容器内上传至github，选参</p><p>&#x2F;opt&#x2F;blog&#x2F;_config.yml                                   挂载hexo文件方便修改，选参</p><p>&#x2F;opt&#x2F;blog&#x2F;_config.butterfly.yml                   挂载hexo主题文件方便修改，选参</p><p>&#x2F;opt&#x2F;blog&#x2F;themes&#x2F;butterfly&#x2F;source&#x2F;img    挂载hexo主题文件静态图片，选参</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;hexo运行脚本&quot;&gt;&lt;a href=&quot;#hexo运行脚本&quot; class=&quot;headerlink&quot; title=&quot;hexo运行脚本&quot;&gt;&lt;/a&gt;hexo运行脚本&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cl</summary>
      
    
    
    
    <category term="hexo" scheme="https://wqblogs.com/categories/hexo/"/>
    
    
    <category term="hexo" scheme="https://wqblogs.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Docker buildx构建多架构镜像</title>
    <link href="https://wqblogs.com/2022/05/12/docker_buildx_install/"/>
    <id>https://wqblogs.com/2022/05/12/docker_buildx_install/</id>
    <published>2022-05-12T02:50:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Docker Buildx 是一个 CLI 插件，它扩展了 docker 命令，完全支持<a href="https://github.com/moby/buildkit">Moby BuildKit</a> 构建器工具包提供的功能。Docker 19.03版本以上都支持buildx。</p><h3 id="启动Buildx"><a href="#启动Buildx" class="headerlink" title="启动Buildx"></a>启动Buildx</h3><h4 id="设置buildx为默认构建器"><a href="#设置buildx为默认构建器" class="headerlink" title="设置buildx为默认构建器"></a>设置buildx为默认构建器</h4><p>可以使用 docker buildx build 命令使用 BuildKit 构建镜像</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx install</span></span><br></pre></td></tr></table></figure><h4 id="创建builder实例"><a href="#创建builder实例" class="headerlink" title="创建builder实例"></a>创建builder实例</h4><p>由于Docker默认的builder实例不支持同时指定多个–platform，所以必须先创建一个新的builder实例</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">适用于国内环境</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx create --use --name=builder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master</span></span><br><span class="line">builder-cn      </span><br><span class="line">使用新创建的builder实例</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx use builder-cn</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx <span class="built_in">ls</span></span></span><br><span class="line">NAME/NODE     DRIVER/ENDPOINT             STATUS   PLATFORMS</span><br><span class="line">builder-cn *  docker-container                     </span><br><span class="line">  builder-cn0 unix:///var/run/docker.sock inactive </span><br><span class="line">default       docker                               </span><br><span class="line">  default     default                     running  linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span><br></pre></td></tr></table></figure><p>Docker 在 Linux 系统架构下是不支持 arm 架构镜像，因此我们可以运行模拟器让其支持该特性。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker run --<span class="built_in">rm</span> --privileged tonistiigi/binfmt:latest --install all</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;supported&quot;: [</span><br><span class="line">    &quot;linux/amd64&quot;,</span><br><span class="line">    &quot;linux/arm64&quot;,</span><br><span class="line">    &quot;linux/riscv64&quot;,</span><br><span class="line">    &quot;linux/ppc64le&quot;,</span><br><span class="line">    &quot;linux/s390x&quot;,</span><br><span class="line">    &quot;linux/386&quot;,</span><br><span class="line">    &quot;linux/mips64le&quot;,</span><br><span class="line">    &quot;linux/mips64&quot;,</span><br><span class="line">    &quot;linux/arm/v7&quot;,</span><br><span class="line">    &quot;linux/arm/v6&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;emulators&quot;: [</span><br><span class="line">    &quot;qemu-aarch64&quot;,</span><br><span class="line">    &quot;qemu-arm&quot;,</span><br><span class="line">    &quot;qemu-mips64&quot;,</span><br><span class="line">    &quot;qemu-mips64el&quot;,</span><br><span class="line">    &quot;qemu-ppc64le&quot;,</span><br><span class="line">    &quot;qemu-riscv64&quot;,</span><br><span class="line">    &quot;qemu-s390x&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="启动构建器"><a href="#启动构建器" class="headerlink" title="启动构建器"></a>启动构建器</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx inspect builder-cn --bootstrap</span></span><br><span class="line">[+] Building 27.6s (1/1) FINISHED                                                                                     </span><br><span class="line"> =&gt; [internal] booting buildkit                                                                                 27.6s</span><br><span class="line"> =&gt; =&gt; pulling image dockerpracticesig/buildkit:master                                                          25.5s</span><br><span class="line"> =&gt; =&gt; creating container buildx_buildkit_builder-cn0                                                            2.1s</span><br><span class="line">Name:   builder-cn</span><br><span class="line">Driver: docker-container</span><br><span class="line"></span><br><span class="line">Nodes:</span><br><span class="line">Name:      builder-cn0</span><br><span class="line">Endpoint:  unix:///var/run/docker.sock</span><br><span class="line">Status:    running</span><br><span class="line">Platforms: linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx <span class="built_in">ls</span></span></span><br><span class="line">NAME/NODE     DRIVER/ENDPOINT             STATUS  PLATFORMS</span><br><span class="line">builder-cn *  docker-container                    </span><br><span class="line">  builder-cn0 unix:///var/run/docker.sock running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6</span><br><span class="line">default       docker                              </span><br><span class="line">  default     default                     running linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span><br><span class="line">nux/arm/v6</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">12.22</span>.<span class="number">7</span>-alpine</span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/blog</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add git openssh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install hexo-cli -g &amp;&amp; hexo init . \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; npm install hexo-renderer-pug hexo-renderer-stylus --save \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; npm install hexo-generator-searchdb --save \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; npm install hexo-wordcount --save \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; npm install hexo-generator-feed --save \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; npm install hexo-deployer-git --save </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.email <span class="string">&quot;weiqun_h@163.com&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.name <span class="string">&quot;weiqun_h@163.com&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> -b master https://gitee.com/immyw/hexo-theme-butterfly.git themes/butterfly</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s#^theme\:.*#theme:\ butterfly#g&#x27;</span> _config.yml</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/opt/blog/source&quot;</span>]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">4000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;hexo&quot;</span>, <span class="string">&quot;server&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>这是一个多阶段构建 Dockerfile，使用node-alpine镜像来构建应用，再node镜像中安装hexo应用及插件。现在就可以使用 buildx 构建一个支持 arm、arm64 和 amd64 多架构的 Docker 镜像了，同时将其推送到 Docker Hub。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker buildx build --platform linux/arm64,linux/amd64 -t heweiqun/hexo:202205121314-node-12.22.7 . --push</span> </span><br><span class="line">[+] Building 12.4s (30/30) FINISHED                                                                                                                                                                                                                                                                 </span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                                                                           0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 931B                                                                                                                                                                                                                                                           0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                                                                                                                                                                                                0.0s</span><br><span class="line"> =&gt; [linux/arm64 internal] load metadata for docker.io/library/node:12.22.7-alpine                                                                                                                                                                                                             5.0s</span><br><span class="line"> =&gt; [linux/amd64 internal] load metadata for docker.io/library/node:12.22.7-alpine                                                                                                                                                                                                             3.3s</span><br><span class="line"> =&gt; [auth] library/node:pull token for registry-1.docker.io                                                                                                                                                                                                                                    0.0s</span><br><span class="line"> =&gt; [auth] library/node:pull token for registry-1.docker.io                                                                                                                                                                                                                                    0.0s</span><br><span class="line"> =&gt; [linux/arm64  1/10] FROM docker.io/library/node:12.22.7-alpine@sha256:0eca266c5fe38ba93aebac00e45c9ac1bb7328b0702a6dc10e1a6ea543d49301                                                                                                                                                     0.0s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/node:12.22.7-alpine@sha256:0eca266c5fe38ba93aebac00e45c9ac1bb7328b0702a6dc10e1a6ea543d49301                                                                                                                                                                   0.0s</span><br><span class="line"> =&gt; [linux/amd64  1/10] FROM docker.io/library/node:12.22.7-alpine@sha256:0eca266c5fe38ba93aebac00e45c9ac1bb7328b0702a6dc10e1a6ea543d49301                                                                                                                                                     0.0s</span><br><span class="line"> =&gt; =&gt; resolve docker.io/library/node:12.22.7-alpine@sha256:0eca266c5fe38ba93aebac00e45c9ac1bb7328b0702a6dc10e1a6ea543d49301                                                                                                                                                                   0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  2/10] WORKDIR /opt/blog                                                                                                                                                                                                                                               0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  3/10] RUN sed -i &#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27; /etc/apk/repositories                                                                                                                                                                                0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  4/10] RUN npm config set registry https://registry.npm.taobao.org                                                                                                                                                                                                     0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  5/10] RUN apk --no-cache add git openssh                                                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  6/10] RUN npm install hexo-cli -g &amp;&amp; hexo init .   &amp;&amp; npm install hexo-renderer-pug hexo-renderer-stylus --save   &amp;&amp; npm install hexo-generator-searchdb --save   &amp;&amp; npm install hexo-wordcount --save   &amp;&amp; npm install hexo-generator-feed --save   &amp;&amp; npm install   0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  7/10] RUN git config --global user.email &quot;weiqun_h@163.com&quot;                                                                                                                                                                                                           0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  8/10] RUN git config --global user.name &quot;weiqun_h@163.com&quot;                                                                                                                                                                                                            0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64  9/10] RUN git clone -b master https://gitee.com/immyw/hexo-theme-butterfly.git themes/butterfly                                                                                                                                                                       0.0s</span><br><span class="line"> =&gt; CACHED [linux/arm64 10/10] RUN sed -i &#x27;s#^theme\:.*#theme:\ butterfly#g&#x27; _config.yml                                                                                                                                                                                                       0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  2/10] WORKDIR /opt/blog                                                                                                                                                                                                                                               0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  3/10] RUN sed -i &#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27; /etc/apk/repositories                                                                                                                                                                                0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  4/10] RUN npm config set registry https://registry.npm.taobao.org                                                                                                                                                                                                     0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  5/10] RUN apk --no-cache add git openssh                                                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  6/10] RUN npm install hexo-cli -g &amp;&amp; hexo init .   &amp;&amp; npm install hexo-renderer-pug hexo-renderer-stylus --save   &amp;&amp; npm install hexo-generator-searchdb --save   &amp;&amp; npm install hexo-wordcount --save   &amp;&amp; npm install hexo-generator-feed --save   &amp;&amp; npm install   0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  7/10] RUN git config --global user.email &quot;weiqun_h@163.com&quot;                                                                                                                                                                                                           0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  8/10] RUN git config --global user.name &quot;weiqun_h@163.com&quot;                                                                                                                                                                                                            0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64  9/10] RUN git clone -b master https://gitee.com/immyw/hexo-theme-butterfly.git themes/butterfly                                                                                                                                                                       0.0s</span><br><span class="line"> =&gt; CACHED [linux/amd64 10/10] RUN sed -i &#x27;s#^theme\:.*#theme:\ butterfly#g&#x27; _config.yml                                                                                                                                                                                                       0.0s</span><br><span class="line"> =&gt; exporting to image                                                                                                                                                                                                                                                                         7.3s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                                                                                                                                                                                                        0.0s</span><br><span class="line"> =&gt; =&gt; exporting manifest sha256:7b76ebe12ed29c8a2de58074ef521498d12a8fc3da015e35cf6428584eddc3cb                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; =&gt; exporting config sha256:5894ca12ba0310fddace94f35746c55705d8e7399f65f68028cfd327765aafb4                                                                                                                                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; exporting manifest sha256:974f7ea6dfd51efe20d10c37468cbf3654b6f38859f9b0c0318a732e11c8ef50                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; =&gt; exporting config sha256:ecfb0d9a8a68f196fbb306aefd8b7d82dc4c19d329c9366307d23f83b27da2ad                                                                                                                                                                                                0.0s</span><br><span class="line"> =&gt; =&gt; exporting manifest list sha256:748356e1191dd4eb9e6aa9cc76646902eceb1c107ba83bb5a019c0a5182f2089                                                                                                                                                                                         0.0s</span><br><span class="line"> =&gt; =&gt; pushing layers                                                                                                                                                                                                                                                                          6.1s</span><br><span class="line"> =&gt; =&gt; pushing manifest for docker.io/heweiqun/hexo:202205121314-node-12.22.7@sha256:748356e1191dd4eb9e6aa9cc76646902eceb1c107ba83bb5a019c0a5182f2089                                                                                                                                          1.1s</span><br><span class="line"> =&gt; [auth] heweiqun/hexo:pull,push token for registry-1.docker.io                                                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; [auth] heweiqun/hexo:pull,push token for registry-1.docker.io                                                                                                                                                                                                                              0.0s</span><br><span class="line"> =&gt; [auth] heweiqun/hexo:pull,push token for registry-1.docker.io                                                                                                                                                                                                                              0.0s</span><br></pre></td></tr></table></figure><p>–platform   选择构建的平台</p><p>–push          会将构建好的镜像推送至仓库</p><p>– load          会将构建好的镜像存放至本地</p><p>现在就可以通过 docker pull  heweiqun&#x2F;hexo:202205121314-node-12.22.7拉取刚刚创建的镜像了，Docker 将会根据你的 CPU 架构拉取匹配的镜像。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h3&gt;&lt;p&gt;Docker Buildx 是一个 CLI 插件，它扩展了 docker 命令，完全支持&lt;a href=&quot;https://github.co</summary>
      
    
    
    
    <category term="docker" scheme="https://wqblogs.com/categories/docker/"/>
    
    
    <category term="docker" scheme="https://wqblogs.com/tags/docker/"/>
    
    <category term="hexo" scheme="https://wqblogs.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes安装部署sonarqube</title>
    <link href="https://wqblogs.com/2021/08/09/sonarqube%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/"/>
    <id>https://wqblogs.com/2021/08/09/sonarqube%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/</id>
    <published>2021-08-09T08:35:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="sonarqube部署安装"><a href="#sonarqube部署安装" class="headerlink" title="sonarqube部署安装"></a>sonarqube部署安装</h2><h3 id="镜像准备"><a href="#镜像准备" class="headerlink" title="镜像准备"></a>镜像准备</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">postgres:11.6</span><br><span class="line">sonarqube:9.0.0-community</span><br><span class="line">busybox:1.27.1</span><br></pre></td></tr></table></figure><h3 id="安装postgres"><a href="#安装postgres" class="headerlink" title="安装postgres"></a>安装postgres</h3><p>sonarqube7.9及以上使用postgres为数据库使用</p><div class="tabs" id="postgres"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#postgres-1">PVC</button></li><li class="tab"><button type="button" data-href="#postgres-2">Deployment</button></li><li class="tab"><button type="button" data-href="#postgres-3">Service</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="postgres-1"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonar-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="postgres-2"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sonar-db</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sonar-db</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sonar-db</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-mysql</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">sonar-mysql</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;postgres:11.6&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_DB</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sonardb</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sonar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sonar</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">800m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-mysql</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="postgres-3"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-port-0</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonar-db</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h3 id="安装sonarqube"><a href="#安装sonarqube" class="headerlink" title="安装sonarqube"></a>安装sonarqube</h3><div class="tabs" id="sonarqube"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sonarqube-1">PVC</button></li><li class="tab"><button type="button" data-href="#sonarqube-2">Deployment</button></li><li class="tab"><button type="button" data-href="#sonarqube-3">Service</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sonarqube-1"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonar-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonar-extensions</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sonarqube-2"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">sonarqube</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-extensions</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">sonar-extensions</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">sonar-data</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-sysctl</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;busybox:1.27.1&#x27;</span></span><br><span class="line">          <span class="attr">command:</span>   <span class="comment"># elasticsearch用户拥有的内存权限太小，es启动会报错，此命令保证es正常启动</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sysctl</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;-w&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vm.max_map_count=262144</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">800m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">securityContext:</span>   <span class="comment"># 配置特权</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;sonarqube:9.0.0-community&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_USERNAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sonar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sonar</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SONARQUBE_JDBC_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;jdbc:postgresql://sonar-db.demo:5432/sonardb&#x27;</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">800m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-extensions</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/opt/sonarqube/extensions</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sonar-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/opt/sonarqube/data</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">240</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sonarqube-3"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-port-0</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sonarqube</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP|NodePort</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p><img src="/image/sonar/image-20210809163313805.png" alt="image-20210809163313805"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;sonarqube部署安装&quot;&gt;&lt;a href=&quot;#sonarqube部署安装&quot; class=&quot;headerlink&quot; title=&quot;sonarqube部署安装&quot;&gt;&lt;/a&gt;sonarqube部署安装&lt;/h2&gt;&lt;h3 id=&quot;镜像准备&quot;&gt;&lt;a href=&quot;#镜像准备&quot;</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="jenkins" scheme="https://wqblogs.com/categories/Kubernetes/jenkins/"/>
    
    
    <category term="jenkins" scheme="https://wqblogs.com/tags/jenkins/"/>
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes实现jenkins slave动态伸缩</title>
    <link href="https://wqblogs.com/2021/04/23/Kubernetes%E6%90%AD%E5%BB%BAjenkins%E9%9B%86%E7%BE%A4/"/>
    <id>https://wqblogs.com/2021/04/23/Kubernetes%E6%90%AD%E5%BB%BAjenkins%E9%9B%86%E7%BE%A4/</id>
    <published>2021-04-23T06:47:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="kubernetes实现jenkins-slave动态伸缩"><a href="#kubernetes实现jenkins-slave动态伸缩" class="headerlink" title="kubernetes实现jenkins slave动态伸缩"></a>kubernetes实现jenkins slave动态伸缩</h1><ul><li>在Kubernetes中使用Jenkins的优点：</li></ul><ol><li>Master服务高可用：当Jenkins Master出现故障时，Kubernetes 会自动创建一个新的Jenkins Master容器，并且将Volume分配给新创建的容器，保证数据不丢失，从而达到集群服务高可用。</li><li>Slave动态伸缩：合理使用资源，每次运行Job时，会自动创建一个Jenkins Slave，Job完成后，Slave自动注销并删除容器，资源自动释放，而且Kubernetes会根据每个资源使用情况，动态分配Slave到空闲的节点上创建，降低出现因某节点资源利用率高，还排队等待在该节点的情况。</li><li>扩展性好：当Kubernetes集群的资源严重不足而导致Job排队等待时，可以很容易的添加一个Kubernetes Node到集群中，从而实现扩展。</li></ol><ul><li>Kubernetes搭建jenkins集群</li></ul><p><img src="https://www.wqblogs.com:4443/image/jenkins-slave/k8s-jenkins.png"></p><p>当Jenkins Master 接收到Build请求时，会根据配置的Label动态创建一个运行在Pod中的Jenkins Slave并注册到Master上，当运行完Job后，这个Slave会被注销并且这个Pod也会自动删除，恢复到最初状态</p><h2 id="部署-jenkins"><a href="#部署-jenkins" class="headerlink" title="部署 jenkins"></a>部署 jenkins</h2><h3 id="部署思路"><a href="#部署思路" class="headerlink" title="部署思路"></a>部署思路</h3><ol><li>在jenkins-master里使用Kubernetes plugin创建进行slave的动态伸缩</li><li>使用nfs存储做为挂载jenkins-master的jenkins_home目录，构建时slave的maven缓存的m2目录，保留slave每次构建产生的数据（workspace目录中的每个job）</li></ol><h3 id="所需镜像"><a href="#所需镜像" class="headerlink" title="所需镜像"></a>所需镜像</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jenkins:2.276</span><br><span class="line">jenkins/inbound-agent:4.3-4</span><br><span class="line">tomcat:8.5.64-jdk8</span><br><span class="line">docker:20.10.6</span><br><span class="line">maven:3.6-jdk-8</span><br><span class="line">bitnami/kubectl:1.18.18</span><br></pre></td></tr></table></figure><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>部署方式可以使用<a href="https://github.com/jenkinsci/kubernetes-plugin/tree/master/src/main/kubernetes">Kubernetes plugin官网</a> 提供的部署yaml，咱们使用自定义的deployment</p><div class="tabs" id="treafik"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#treafik-1">RBAC</button></li><li class="tab"><button type="button" data-href="#treafik-2">Deployment</button></li><li class="tab"><button type="button" data-href="#treafik-3">SVC</button></li><li class="tab"><button type="button" data-href="#treafik-4">PVC</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="treafik-1"><p>service-account.yml 此文件用于创建k8s的rbac，授权给后面的Jenkins应用可以创建和删除slave的pod</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>, <span class="string">&quot;apps&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">demo</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-2"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">jenkins</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">jenkins-home</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">image:</span> <span class="number">10.166</span><span class="number">.33</span><span class="number">.110</span><span class="string">/infra/jenkins:v2.276</span>   <span class="comment"># 官方镜像为jenkins为jenkins:v2.276，为了节省下载时间已经push到自己到harbor仓库</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">50000</span>              <span class="comment"># agent连接端口</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2048m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">4096Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">512m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">5</span>          </span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-Xms2G -Xmx2G -Duser.timezone=Asia/Shanghai&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TRY_UPGRADE_IF_NO_MARKER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span>          </span><br><span class="line">      <span class="attr">securityContext:</span>             <span class="comment"># root权限</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-3"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>    </span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-4"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-agent</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-m2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>查看创建状态</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get po -ndemo -l app=jenkins</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-7d96c568cf-trvfs   1/1     Running   0          24h</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pvc -ndemo |grep jenkins</span></span><br><span class="line">jenkins-agent   Bound    pvc-1168ca97-4765-492b-a1ac-6c98d4c2df60   1Gi        RWX            nfs            25m</span><br><span class="line">jenkins-home    Bound    pvc-d7fdfcde-da3c-44dd-b882-5f49b7ee5a9b   1Gi        RWX            nfs            2d5h</span><br><span class="line">jenkins-m2      Bound    pvc-3c9d2f99-e239-45f1-942a-6874058c2b68   1Gi        RWX            nfs            29h</span><br></pre></td></tr></table></figure><p>查看jenkins密码</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it jenkins-7d96c568cf-trvfs -n demo -- <span class="built_in">cat</span> /var/jenkins_home/secrets/initialAdminPassword</span></span><br></pre></td></tr></table></figure><h2 id="jenkins-配置"><a href="#jenkins-配置" class="headerlink" title="jenkins 配置"></a>jenkins 配置</h2><h3 id="插件配置"><a href="#插件配置" class="headerlink" title="插件配置"></a>插件配置</h3><p>更换插件源</p><p>系统管理&#x3D;&gt; 插件管理&#x3D;&gt; 高级 &#x3D;&gt; <a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a> #清华源<br>安装插件</p><ul><li>选择系统管理 &#x3D;&gt; 插件管理 &#x3D;&gt; 可选插件 &#x3D;&gt; Blue Ocean</li><li>选择系统管理 &#x3D;&gt; 插件管理 &#x3D;&gt; 可选插件 &#x3D;&gt; Kubernetes</li></ul><h3 id="Cloud配置"><a href="#Cloud配置" class="headerlink" title="Cloud配置"></a>Cloud配置</h3><ul><li>后端master节点生成证书</li></ul><p>打开~&#x2F;.kube&#x2F;config文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">复制certificate-authority-data的内容，运行以下命令生成client.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;certificate-authority-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; ca.crt</span></span><br><span class="line">复制client-certificate-data的内容，运行以下命令生成client.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;client-certificate-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; client.crt</span></span><br><span class="line">复制client-key-data的内容，运行以下命令生成client.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;client-key-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; client.key</span></span><br><span class="line"></span><br><span class="line">再根据前面步骤生成的ca.crt, client.crt和client.key来生成PKCS12格式的cert.pfx</span><br><span class="line">以下命令运行时，需要输入4位以上的密码</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl pkcs12 -<span class="built_in">export</span> -out cert.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile ca.crt</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure><ul><li>jenkins创建证书凭证</li></ul><p>选择 Certificate 类型  添加证书</p><p><img src="/image/jenkins-slave/jenkins-k8s-crt.png"></p><ul><li>配置Kubernetes集群</li></ul><p>系统配置拉到最后会看见一个Cloud</p><p><img src="/image/jenkins-slave/cloud-k8s.png"></p><p>配置jenkins地址</p><p><img src="/image/jenkins-slave/cloud-jenkins.png"></p><h3 id="gitlab配置公钥"><a href="#gitlab配置公钥" class="headerlink" title="gitlab配置公钥"></a>gitlab配置公钥</h3><p>代码仓库：代码仓库：<a href="https://github.com/wq-h/demo-2048.git">https://github.com/wq-h/demo-2048.git</a></p><ul><li>创建密钥</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssh-keygen -t rsa -b 2048 -C <span class="string">&quot;weiqun_h@163.com&quot;</span> -N <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:lo1dX2Kj+5Z8n7LiICLc9yYJdkhlY9W2YpNsTn/pmrI weiqun_h@163.com</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|        ...      |</span><br><span class="line">|       =   o     |</span><br><span class="line">|      + o o o + .|</span><br><span class="line">|     .   &amp; o + + |</span><br><span class="line">|    . . S * . o  |</span><br><span class="line">|  . .+ o . . +   |</span><br><span class="line">|   o.ooo..  +. . |</span><br><span class="line">|    . oooo...++ o|</span><br><span class="line">|        oE++oo+oo|</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure><ul><li>gitlab配置公钥</li></ul><p><img src="/image/gitlab_key.png"></p><ul><li>jenkins 创建凭据</li></ul><p>选择ssh username with private key类型  添加私钥<br><img src="/image/jenkins_key.png"></p><h2 id="jenkins动态slave测试"><a href="#jenkins动态slave测试" class="headerlink" title="jenkins动态slave测试"></a>jenkins动态slave测试</h2><p>pipeline文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">def</span> <span class="string">label</span> <span class="string">=</span> <span class="string">&quot;jenkins-slave-$&#123;UUID.randomUUID().toString()&#125;&quot;</span> <span class="string">//</span></span><br><span class="line"><span class="string">podTemplate(label:</span> <span class="string">label,</span> <span class="attr">cloud:</span> <span class="string">&#x27;kubernetes&#x27;</span><span class="string">)</span> &#123;</span><br><span class="line">    <span class="string">node(label)</span> &#123;</span><br><span class="line">        <span class="string">stage(&#x27;Run</span> <span class="string">shell&#x27;)</span> &#123;</span><br><span class="line">            <span class="string">sh</span> <span class="string">&#x27;sleep 10s&#x27;</span></span><br><span class="line">            <span class="string">sh</span> <span class="string">&#x27;echo hello world.&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/jenkins-slave/slave-test-pipeline.png"></p><h2 id="配置java流水线"><a href="#配置java流水线" class="headerlink" title="配置java流水线"></a>配置java流水线</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li>.docker&#x2F;config.json</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker login -u &lt;用户名&gt; -p &lt;密码&gt; 10.166.33.110</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create secret generic jenkins-docker-cfg -n demo --from-file=/root/.docker/config.json</span></span><br><span class="line">secret/jenkins-docker-cfg created</span><br></pre></td></tr></table></figure><ul><li>.kube&#x2F;config</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create secret generic jenkins-k8s-cfg -n demo --from-file=/root/.kube/config</span></span><br><span class="line">secret/jenkins-k8s-cfg created</span><br></pre></td></tr></table></figure><h3 id="jenkins配置模板"><a href="#jenkins配置模板" class="headerlink" title="jenkins配置模板"></a>jenkins配置模板</h3><p><a href="https://plugins.jenkins.io/kubernetes/">Kubernetes Plugin</a></p><ul><li>配置pod模板</li></ul><p>系统配置 &#x3D;&gt; Cloud &#x3D;&gt; Pod Templates</p><p><img src="/image/jenkins-slave/cloud-pod-templates.png"></p><ul><li>配置容器模板</li></ul><p>jnlp agent镜像</p><p><img src="/image/jenkins-slave/jnlp.template.png"></p><p>maven镜像</p><p><img src="/image/jenkins-slave/maven-template.png"></p><p>docker镜像</p><p><img src="/image/jenkins-slave/docker-template.png"></p><p>kubectl镜像</p><p><img src="/image/jenkins-slave/kubetcl-template.png"></p><ul><li>配置存储卷</li></ul><p>本地文件挂载</p><p><img src="/image/jenkins-slave/pod-hostvolume.png"></p><p>pvc挂载</p><p><img src="/image/jenkins-slave/pod-pvcvolume.png"></p><p>secret挂载</p><p><img src="/image/jenkins-slave/pod-secretvolume.png"></p><h3 id="创建jenkins项目"><a href="#创建jenkins项目" class="headerlink" title="创建jenkins项目"></a>创建jenkins项目</h3><ul><li>创建pipeline项目</li></ul><p><img src="/image/jenkins-slave/jenkins-pipeline.png"></p><ul><li>参数化构建工程，选择字符参数</li></ul><p>名称:   APP_NAME<br>默认值: demo-2048<br>描述:   项目名称，用于创建deployment名称，例如demo-2048</p><p>名称:   APP_NS<br>默认值: demo<br>描述:   namespace名称，deployment资源创建指定的ns</p><p>名称:   GIT_VER<br>默认值: master<br>描述:   项目所在git中央仓库对应项目的分支或者版本号，例如master分支：master，commit ID：b8028aae</p><p>名称:   GIT_REPO<br>默认值: ssh:&#x2F;&#x2F;<a href="mailto:&#103;&#105;&#116;&#x40;&#x31;&#x30;&#46;&#49;&#54;&#54;&#46;&#51;&#51;&#x2e;&#49;&#49;&#x36;">&#103;&#105;&#116;&#x40;&#x31;&#x30;&#46;&#49;&#54;&#54;&#46;&#51;&#51;&#x2e;&#49;&#49;&#x36;</a>:19922&#x2F;root&#x2F;demo-2048.git<br>描述:   项目所在的git中央仓库的地址</p><p>名称:   MVN_DIR<br>默认值: .&#x2F;<br>描述:   编译项目目录，默认为项目的根目录</p><p>名称:   MVN_CMD<br>默认值: mvn clean package -Dmaven.test.skip&#x3D;true<br>描述:   执行mvn编译所用的命令</p><p>名称:   IMAGE_NAME<br>默认值: demo&#x2F;demo-2048<br>描述:   docker镜像名称，格式：&lt;仓库名&gt;&#x2F;&lt;镜像名&gt; 例如：demo&#x2F;demo-2048</p><p>名称:   IMAGE_REPO<br>默认值: 10.166.33.110<br>描述:   docker镜像仓库名称</p><p><img src="/image/jenkins-slave/jenkins-parameter.png"></p><h3 id="pipeline文件"><a href="#pipeline文件" class="headerlink" title="pipeline文件"></a>pipeline文件</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">流水线的最外层结构，代表整条pipeline，包含着pipeline完整逻辑</span></span><br><span class="line"><span class="string">pipeline</span> &#123;</span><br><span class="line">  <span class="string">//</span> <span class="string">环境变量的定义</span></span><br><span class="line">  <span class="string">environment</span> &#123;</span><br><span class="line">   <span class="string">IMAGE=&quot;$</span>&#123;<span class="string">params.IMAGE_REPO</span>&#125;<span class="string">/$</span>&#123;<span class="string">params.IMAGE_NAME</span>&#125;<span class="string">:$</span>&#123;<span class="string">params.GIT_VER</span>&#125;<span class="string">-$</span>&#123;<span class="string">BUILD_NUMBER</span>&#125;<span class="string">&quot;  // 通过 $&#123;params.xxx&#125; 的方式对此参数进行引用</span></span><br><span class="line"><span class="string">   APP_NS=&quot;</span><span class="string">$</span>&#123;<span class="string">params.APP_NS</span>&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string">   APP_NAME=&quot;</span><span class="string">$</span>&#123;<span class="string">params.APP_NAME</span>&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // pipeline中单独指令，用于指定流水的执行位置，它可能是代表着slave主机的某个物理机、虚拟机或者容器</span></span><br><span class="line"><span class="string">  agent &#123;</span></span><br><span class="line"><span class="string">    node &#123;</span></span><br><span class="line"><span class="string">  // label设置为cloud配置的pod 模板所定义的标签</span></span><br><span class="line"><span class="string">      label &#x27;jenkins-mvn&#x27;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // 用于包含所有的stage的定义</span></span><br><span class="line"><span class="string">  stages &#123;</span></span><br><span class="line"><span class="string">    // 阶段，代表流水线的一个单独的功能完成时期，例如编译等</span></span><br><span class="line"><span class="string">    stage(&#x27;检出代码&#x27;) &#123;</span></span><br><span class="line"><span class="string">  // 步骤，用于在stage中定义完成该阶段功能所需经历的一系列步骤</span></span><br><span class="line"><span class="string">      steps &#123;</span></span><br><span class="line"><span class="string">        // 递归删除WORKSPACE下的文件和文件夹,避免缓存导致构建问题</span></span><br><span class="line"><span class="string">        deleteDir()</span></span><br><span class="line"><span class="string">// credentialsId为ssh 凭据的id</span></span><br><span class="line"><span class="string">        checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &quot;</span><span class="string">$</span>&#123;<span class="string">params.GIT_VER</span>&#125;<span class="string">&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;</span><span class="string">gitlabauth&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;params.GIT_REPO&#125;&quot;</span>]]]<span class="string">)</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="string">stage(&#x27;构建代码&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span>&#123;</span><br><span class="line">          <span class="string">//</span> <span class="string">用于创建容器的容器模板</span></span><br><span class="line">      <span class="string">container(&#x27;maven&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;cd $&#123;params.MVN_DIR&#125; &amp;&amp; $&#123;params.MVN_CMD&#125;&quot;</span></span><br><span class="line">  <span class="string">sh</span> <span class="string">&quot;cd target &amp;&amp; jar -xf $&#123;params.APP_NAME&#125;.war&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="string">//</span> <span class="string">post定义将在pipeline运行或stage结束时运行的操作</span></span><br><span class="line">      <span class="string">post</span> &#123;</span><br><span class="line">        <span class="string">//</span> <span class="string">成功之后提取制品</span></span><br><span class="line">        <span class="string">success</span> &#123;</span><br><span class="line">          <span class="string">archiveArtifacts</span> <span class="string">&quot;target/*.war&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;构建镜像&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">    <span class="string">container(&#x27;docker&#x27;)</span> &#123;</span><br><span class="line">  <span class="string">sh</span> <span class="string">&quot;cp ./Dockerfiles/Dockerfile ./target&quot;</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;cd ./target &amp;&amp; docker build -t $&#123;params.IMAGE_REPO&#125;/$&#123;params.IMAGE_NAME&#125;:$&#123;params.GIT_VER&#125;-$&#123;BUILD_NUMBER&#125; .&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;推送镜像&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">    <span class="string">container(&#x27;docker&#x27;)</span> &#123;</span><br><span class="line">          <span class="string">sh</span> <span class="string">&quot;docker push $&#123;params.IMAGE_REPO&#125;/$&#123;params.IMAGE_NAME&#125;:$&#123;params.GIT_VER&#125;-$&#123;BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">stage(&#x27;更新服务&#x27;)</span> &#123;</span><br><span class="line">      <span class="string">steps</span> &#123;</span><br><span class="line">    <span class="string">container(&#x27;kubectl&#x27;)</span> &#123;</span><br><span class="line">  <span class="comment"># envsubst 将环境变量传递给文件</span></span><br><span class="line">      <span class="string">sh</span> <span class="string">&quot;envsubst &lt; template/$&#123;params.APP_NAME&#125;.yaml |kubectl --kubeconfig=/home/jenkins/agent/.kube/config apply -f -&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get po -ndemo|egrep <span class="string">&#x27;demo-2048|jenkins-mvn&#x27;</span></span></span><br><span class="line">demo-2048-6b7ffc87bc-9jd7m                 1/1     Running   0          6m14s</span><br><span class="line">jenkins-mvn-qq4n9                          4/4     Running   0          6m43s</span><br></pre></td></tr></table></figure><p><img src="/image/jenkins-slave/jenkins-java-build.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;kubernetes实现jenkins-slave动态伸缩&quot;&gt;&lt;a href=&quot;#kubernetes实现jenkins-slave动态伸缩&quot; class=&quot;headerlink&quot; title=&quot;kubernetes实现jenkins slave动态伸缩&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="jenkins" scheme="https://wqblogs.com/categories/Kubernetes/jenkins/"/>
    
    
    <category term="jenkins" scheme="https://wqblogs.com/tags/jenkins/"/>
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>kubeadm更新证书</title>
    <link href="https://wqblogs.com/2021/02/25/kubeadm%E6%9B%B4%E6%8D%A2%E8%AF%81%E4%B9%A6/"/>
    <id>https://wqblogs.com/2021/02/25/kubeadm%E6%9B%B4%E6%8D%A2%E8%AF%81%E4%B9%A6/</id>
    <published>2021-02-25T07:44:50.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>kubeadm 默认证书为一年，一年过期后，会导致api service不可用，使用过程中会出现：x509: certificate has expired or is not yet valid.</p><h2 id="查看集群版本信息"><a href="#查看集群版本信息" class="headerlink" title="查看集群版本信息"></a>查看集群版本信息</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubeadm version</span></span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:&quot;1&quot;, Minor:&quot;19&quot;, GitVersion:&quot;v1.19.3&quot;, GitCommit:&quot;1e11e4a2108024935ecfcb2912226cedeafd99df&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2020-10-14T12:47:53Z&quot;, GoVersion:&quot;go1.15.2&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="查看集群证书过期时间"><a href="#查看集群证书过期时间" class="headerlink" title="查看集群证书过期时间"></a>查看集群证书过期时间</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubeadm alpha certs check-expiration</span></span><br><span class="line">[check-expiration] Reading configuration from the cluster...</span><br><span class="line">[check-expiration] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span><br><span class="line"></span><br><span class="line">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class="line">admin.conf                 Feb 06, 2022 08:13 UTC   346d                                    no      </span><br><span class="line">apiserver                  Feb 06, 2022 08:12 UTC   346d            ca                      no      </span><br><span class="line">apiserver-etcd-client      Feb 06, 2022 08:12 UTC   346d            etcd-ca                 no      </span><br><span class="line">apiserver-kubelet-client   Feb 06, 2022 08:12 UTC   346d            ca                      no      </span><br><span class="line">controller-manager.conf    Feb 06, 2022 08:13 UTC   346d                                    no      </span><br><span class="line">etcd-healthcheck-client    Nov 06, 2021 09:50 UTC   254d            etcd-ca                 no      </span><br><span class="line">etcd-peer                  Nov 06, 2021 09:50 UTC   254d            etcd-ca                 no      </span><br><span class="line">etcd-server                Nov 06, 2021 09:50 UTC   254d            etcd-ca                 no      </span><br><span class="line">front-proxy-client         Feb 06, 2022 08:12 UTC   346d            front-proxy-ca          no      </span><br><span class="line">scheduler.conf             Feb 06, 2022 08:13 UTC   346d                                    no      </span><br><span class="line"></span><br><span class="line">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class="line">ca                      Nov 04, 2030 09:50 UTC   9y              no      </span><br><span class="line">etcd-ca                 Nov 04, 2030 09:50 UTC   9y              no      </span><br><span class="line">front-proxy-ca          Nov 04, 2030 09:50 UTC   9y              no    </span><br></pre></td></tr></table></figure><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/kubernetes/kubernetes.git</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> kubernetes/</span></span><br><span class="line">检出相同版本的kubernetes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git checkout v1.19.3</span></span><br></pre></td></tr></table></figure><h2 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"># vim cmd/kubeadm/app/constants/constants.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">        <span class="comment">// KubernetesDir is the directory Kubernetes owns for storing various configuration files</span></span><br><span class="line">        KubernetesDir = <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">        <span class="comment">// ManifestsSubDirName defines directory name to store manifests</span></span><br><span class="line">        ManifestsSubDirName = <span class="string">&quot;manifests&quot;</span></span><br><span class="line">        <span class="comment">// TempDirForKubeadm defines temporary directory for kubeadm</span></span><br><span class="line">        <span class="comment">// should be joined with KubernetesDir.</span></span><br><span class="line">        TempDirForKubeadm = <span class="string">&quot;tmp&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm</span></span><br><span class="line">        CertificateValidity = time.Hour * <span class="number">24</span> * <span class="number">365</span> * <span class="number">100</span> <span class="comment">// 添加 * 100,修改成100年</span></span><br></pre></td></tr></table></figure><h2 id="安装go环境"><a href="#安装go环境" class="headerlink" title="安装go环境"></a>安装go环境</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://dl.google.com/go/go1.15.3.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar xf go1.15.3.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> -rf go /usr/local/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> &gt;&gt;  /etc/profile &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">export PATH=$PATH:/usr/local/go/bin</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">source /etc/profile</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">go version</span></span></span><br><span class="line">go version go1.15.3 linux/amd64</span><br></pre></td></tr></table></figure><h2 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">编译kubeadm, 这里主要编译kubeadm 即可</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make WHAT=cmd/kubeadm GOFLAGS=-v</span></span><br><span class="line">编译完产物在 _output/bin/ 目录下</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./_output/bin/kubeadm version</span></span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:&quot;1&quot;, Minor:&quot;19&quot;, GitVersion:&quot;v1.19.3&quot;, GitCommit:&quot;1e11e4a2108024935ecfcb2912226cedeafd99df&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-02-25T05:41:59Z&quot;, GoVersion:&quot;go1.15.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="备份kubeadm与证书"><a href="#备份kubeadm与证书" class="headerlink" title="备份kubeadm与证书"></a>备份kubeadm与证书</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mkair bak</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> -fr /etc/kubernetes ./bak/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /usr/bin/kubeadm ./bak/</span></span><br></pre></td></tr></table></figure><h2 id="替换证书"><a href="#替换证书" class="headerlink" title="替换证书"></a>替换证书</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> _output/bin/kubeadm /usr/bin/</span></span><br><span class="line">cp: overwrite ‘/usr/bin/kubeadm’? y</span><br><span class="line">[root@zzmaster ~]# kubeadm version</span><br><span class="line">kubeadm version: &amp;version.Info&#123;Major:&quot;1&quot;, Minor:&quot;19&quot;, GitVersion:&quot;v1.19.3&quot;, GitCommit:&quot;1e11e4a2108024935ecfcb2912226cedeafd99df&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-02-25T05:41:59Z&quot;, GoVersion:&quot;go1.15.3&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br><span class="line">生成新的证书</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubeadm alpha certs renew all</span></span><br><span class="line">[renew] Reading configuration from the cluster...</span><br><span class="line">[renew] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span><br><span class="line"></span><br><span class="line">certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed</span><br><span class="line">certificate for serving the Kubernetes API renewed</span><br><span class="line">certificate the apiserver uses to access etcd renewed</span><br><span class="line">certificate for the API server to connect to kubelet renewed</span><br><span class="line">certificate embedded in the kubeconfig file for the controller manager to use renewed</span><br><span class="line">certificate for liveness probes to healthcheck etcd renewed</span><br><span class="line">certificate for etcd nodes to communicate with each other renewed</span><br><span class="line">certificate for serving etcd renewed</span><br><span class="line">certificate for the front proxy client renewed</span><br><span class="line">certificate embedded in the kubeconfig file for the scheduler manager to use renewed</span><br></pre></td></tr></table></figure><h2 id="验证证书是否更新"><a href="#验证证书是否更新" class="headerlink" title="验证证书是否更新"></a>验证证书是否更新</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubeadm alpha certs check-expiration</span></span><br><span class="line">[check-expiration] Reading configuration from the cluster...</span><br><span class="line">[check-expiration] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span><br><span class="line"></span><br><span class="line">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class="line">admin.conf                 Feb 01, 2121 05:54 UTC   99y                                     no      </span><br><span class="line">apiserver                  Feb 01, 2121 05:54 UTC   99y             ca                      no      </span><br><span class="line">apiserver-etcd-client      Feb 01, 2121 05:54 UTC   99y             etcd-ca                 no      </span><br><span class="line">apiserver-kubelet-client   Feb 01, 2121 05:54 UTC   99y             ca                      no      </span><br><span class="line">controller-manager.conf    Feb 01, 2121 05:54 UTC   99y                                     no      </span><br><span class="line">etcd-healthcheck-client    Feb 01, 2121 05:54 UTC   99y             etcd-ca                 no      </span><br><span class="line">etcd-peer                  Feb 01, 2121 05:54 UTC   99y             etcd-ca                 no      </span><br><span class="line">etcd-server                Feb 01, 2121 05:54 UTC   99y             etcd-ca                 no      </span><br><span class="line">front-proxy-client         Feb 01, 2121 05:54 UTC   99y             front-proxy-ca          no      </span><br><span class="line">scheduler.conf             Feb 01, 2121 05:54 UTC   99y                                     no      </span><br><span class="line"></span><br><span class="line">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class="line">ca                      Nov 04, 2030 09:50 UTC   9y              no      </span><br><span class="line">etcd-ca                 Nov 04, 2030 09:50 UTC   9y              no      </span><br><span class="line">front-proxy-ca          Nov 04, 2030 09:50 UTC   9y              no    </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;kubeadm 默认证书为一年，一年过期后，会导致api service不可用，使用过程中会出现：x509: certificate has expired or is not yet valid.&lt;/p&gt;
&lt;h2 id=&quot;查看集群版本信息&quot;&gt;&lt;a href=&quot;#查看集群版</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Traefik 2.x版本</title>
    <link href="https://wqblogs.com/2021/02/24/traefik-2.x/"/>
    <id>https://wqblogs.com/2021/02/24/traefik-2.x/</id>
    <published>2021-02-24T09:16:00.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="资源配置清单"><a href="#资源配置清单" class="headerlink" title="资源配置清单"></a>资源配置清单</h2><div class="tabs" id="treafik"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#treafik-1">CRD</button></li><li class="tab"><button type="button" data-href="#treafik-2">RBAC</button></li><li class="tab"><button type="button" data-href="#treafik-3">ConfigMap</button></li><li class="tab"><button type="button" data-href="#treafik-4">DaemonSet</button></li><li class="tab"><button type="button" data-href="#treafik-5">Middleware</button></li><li class="tab"><button type="button" data-href="#treafik-6">Service</button></li><li class="tab"><button type="button" data-href="#treafik-7">Ingress</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="treafik-1"><p>CRD 自定义资源二次开发能力来扩展 Kubernetes API，通过 CRD 我们可以向 Kubernetes API 中增加新资源类型，而不需要修改 Kubernetes 源码来创建自定义的 API server，该功能大大提高了 Kubernetes 的扩展能力</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutes.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutes</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroute</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">middlewares.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">middlewares</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">middleware</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVer  sion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutetcps.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutetcps</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroutetcp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressrouteudps.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRouteUDP</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressrouteudps</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressrouteudp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tlsoptions.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TLSOption</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tlsoptions</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">tlsoption</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tlsstores.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TLSStore</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tlsstores</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">tlsstore</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefikservices.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">traefikservices</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">traefikservice</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">serverstransports.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ServersTransport</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">serverstransports</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">serverstransport</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-2"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.containo.us</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middlewares</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefikservices</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutetcps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressrouteudps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlsoptions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlsstores</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">serverstransports</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-3"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">traefik.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    ping: &quot;&quot;                    # 启用 Ping          </span></span><br><span class="line"><span class="string">    serversTransport:    </span></span><br><span class="line"><span class="string">      insecureSkipVerify: true  # Traefik 忽略验证代理服务的 TLS 证书</span></span><br><span class="line"><span class="string">    api:</span></span><br><span class="line"><span class="string">      insecure: true            # 允许 HTTP 方式访问 API</span></span><br><span class="line"><span class="string">      dashboard: true           # 启用 Dashboard</span></span><br><span class="line"><span class="string">      debug: false              # 启用 Debug 调试模式</span></span><br><span class="line"><span class="string">    metrics:</span></span><br><span class="line"><span class="string">      prometheus: &quot;&quot;            # 配置 Prometheus 监控指标数据，并使用默认配置</span></span><br><span class="line"><span class="string">    entryPoints:</span></span><br><span class="line"><span class="string">      web:</span></span><br><span class="line"><span class="string">        address: &quot;:80&quot;          # 配置 80 端口，并设置入口名称为 web</span></span><br><span class="line"><span class="string">      websecure:</span></span><br><span class="line"><span class="string">        address: &quot;:443&quot;         # 配置 443 端口，并设置入口名称为 websecure</span></span><br><span class="line"><span class="string">    certificatesResolvers:      # 配置证书解析器</span></span><br><span class="line"><span class="string">      myresolver:               # 解析器名称</span></span><br><span class="line"><span class="string">        acme:                   # 启用acme，acme可以自动创建证书</span></span><br><span class="line"><span class="string">          email: weiqun_h@163.com  # 用于注册的电子邮件地址</span></span><br><span class="line"><span class="string">          storage: acme.json       # 用于证书存储的文件或密钥</span></span><br><span class="line"><span class="string">          httpChallenge:           # 通过在HTTP-01众所周知的URI下配置HTTP资源，使用质询来生成和更新ACME证书</span></span><br><span class="line"><span class="string">            entryPoint: web</span></span><br><span class="line"><span class="string">    providers:</span></span><br><span class="line"><span class="string">      kubernetesCRD: &quot;&quot;         # 启用 Kubernetes CRD 方式来配置路由规则</span></span><br><span class="line"><span class="string">      kubernetesIngress: &quot;&quot;     # 启动 Kubernetes Ingress 方式来配置路由规则</span></span><br><span class="line"><span class="string">    log:</span></span><br><span class="line"><span class="string">      filePath: &quot;&quot;              # 设置调试日志文件存储路径，如果为空则输出到控制台</span></span><br><span class="line"><span class="string">      level: error              # 设置调试日志级别</span></span><br><span class="line"><span class="string">      format: json              # 设置调试日志格式</span></span><br><span class="line"><span class="string">    accessLog:</span></span><br><span class="line"><span class="string">      filePath: &quot;&quot;              # 设置访问日志文件存储路径，如果为空则输出到控制台</span></span><br><span class="line"><span class="string">      format: json              </span></span><br><span class="line"><span class="string">      bufferingSize: 0          # 设置访问日志缓存行数</span></span><br><span class="line"><span class="string">      filters:</span></span><br><span class="line"><span class="string">        retryAttempts: true     # 设置代理访问重试失败时，保留访问日志</span></span><br><span class="line"><span class="string">        minDuration: 20         </span></span><br><span class="line"><span class="string">      fields:                   # 设置访问日志中的字段是否保留（keep 保留、drop 不保留）</span></span><br><span class="line"><span class="string">        defaultMode: keep       </span></span><br><span class="line"><span class="string">        names:                  # 针对访问日志特别字段特别配置保留模式</span></span><br><span class="line"><span class="string">          ClientUsername: drop  </span></span><br><span class="line"><span class="string">        headers:                # 设置 Header 中字段是否保留</span></span><br><span class="line"><span class="string">          defaultMode: keep     </span></span><br><span class="line"><span class="string">          names:                </span></span><br><span class="line"><span class="string">            User-Agent: redact</span></span><br><span class="line"><span class="string">            Authorization: drop</span></span><br><span class="line"><span class="string">            Content-Type: keep</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-4"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus_io_scheme:</span> <span class="string">&quot;traefik&quot;</span></span><br><span class="line">        <span class="attr">prometheus_io_path:</span> <span class="string">&quot;/metrics&quot;</span></span><br><span class="line">        <span class="attr">prometheus_io_port:</span> <span class="string">&quot;8080&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">traefik:v2.4.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">hostPort:</span> <span class="number">80</span>         <span class="comment"># 将容器端口绑定所在服务器的 80 端口</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">websecure</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">              <span class="attr">hostPort:</span> <span class="number">443</span>        <span class="comment"># 将容器端口绑定所在服务器的 443 端口</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">8080</span>  <span class="comment"># Traefik Dashboard 端口</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configfile=/config/traefik.yaml</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/config&quot;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">&quot;config&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">traefik-config</span></span><br><span class="line">      <span class="attr">tolerations:</span>              </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span>           <span class="comment"># 设置容忍所有污点，防止节点被设置污点</span></span><br><span class="line">      <span class="attr">nodeSelector:</span>            </span><br><span class="line">        <span class="attr">IngressProxy:</span> <span class="string">&quot;true&quot;</span>           <span class="comment"># 设置node筛选器，在特定label的节点上启动</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-5"><p>这里配置的声明了一个名为redirectSchemea的中间件，该中间件可以将我们的请求跳转到另外的 scheme 请求，然后将该中间件配置到 HTTP 请求的服务上面</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redirect-https</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">redirectScheme:</span>   <span class="comment"># 重定向中间件</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-6"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">websecure</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">traefik</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="treafik-7"><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ui-http</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`traefik.shisu.com`)</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">middlewares:</span>      <span class="comment"># 重定向中间件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redirect-https</span>      </span><br><span class="line"><span class="meta">---    </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ui-https</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">websecure</span>     <span class="comment"># 注意这里是websecure这个entryPoint，监控443端口</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`traefik.shisu.com`)</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tls:</span>           <span class="comment"># 使用配置文件里定义的解析器</span></span><br><span class="line">    <span class="attr">certResolver:</span> <span class="string">myresolver</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>配置主机标签</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label nodes k8s-node01 IngressProxy=true</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f crd.yaml</span></span><br><span class="line"><span class="attr">Warning:</span> <span class="string">apiextensions.k8s.io/v1beta1</span> <span class="string">CustomResourceDefinition</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">in</span> <span class="string">v1.16+,</span> <span class="string">unavailable</span> <span class="string">in</span> <span class="string">v1.22+;</span> <span class="string">use</span> <span class="string">apiextensions.k8s.io/v1</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ingressroutes.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/middlewares.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ingressroutetcps.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ingressrouteudps.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/tlsoptions.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/tlsstores.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/traefikservices.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/serverstransports.traefik.containo.us</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f rbac.yaml</span></span><br><span class="line"><span class="string">serviceaccount/traefik-ingress-controller</span> <span class="string">unchanged</span></span><br><span class="line"><span class="attr">Warning:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span> <span class="string">ClusterRole</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">in</span> <span class="string">v1.17+,</span> <span class="string">unavailable</span> <span class="string">in</span> <span class="string">v1.22+;</span> <span class="string">use</span> <span class="string">rbac.authorization.k8s.io/v1</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller</span> <span class="string">created</span></span><br><span class="line"><span class="attr">Warning:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span> <span class="string">ClusterRoleBinding</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">in</span> <span class="string">v1.17+,</span> <span class="string">unavailable</span> <span class="string">in</span> <span class="string">v1.22+;</span> <span class="string">use</span> <span class="string">rbac.authorization.k8s.io/v1</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f config.yaml</span></span><br><span class="line"><span class="string">configmap/traefik-config</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f middleware.yaml</span></span><br><span class="line"><span class="string">middleware.traefik.containo.us/redirect-https</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f daemonset.yaml</span></span><br><span class="line"><span class="string">daemonset.apps/traefik-ingress-controller</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f svc.yaml</span></span><br><span class="line"><span class="string">service/traefik</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-http.yaml</span></span><br><span class="line"><span class="string">ingressroute.traefik.containo.us/traefik-ui-http</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-https.yaml</span></span><br><span class="line"><span class="string">ingressroute.traefik.containo.us/traefik-ui-https</span> <span class="string">created</span></span><br></pre></td></tr></table></figure><p><img src="/image/traefik/k8s-traefik.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;资源配置清单&quot;&gt;&lt;a href=&quot;#资源配置清单&quot; class=&quot;headerlink&quot; title=&quot;资源配置清单&quot;&gt;&lt;/a&gt;资源配置清单&lt;/h2&gt;&lt;div class=&quot;tabs&quot; id=&quot;treafik&quot;&gt;&lt;ul class=&quot;nav-tabs&quot;&gt;&lt;li c</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="traefik" scheme="https://wqblogs.com/categories/Kubernetes/traefik/"/>
    
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
    <category term="traefik" scheme="https://wqblogs.com/tags/traefik/"/>
    
  </entry>
  
  <entry>
    <title>Gitlab+Drone对接Kubernetes实现自动化</title>
    <link href="https://wqblogs.com/2021/02/08/drone%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    <id>https://wqblogs.com/2021/02/08/drone%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96/</id>
    <published>2021-02-08T09:16:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="gitlab创建OAuth应用"><a href="#gitlab创建OAuth应用" class="headerlink" title="gitlab创建OAuth应用"></a>gitlab创建OAuth应用</h2><p>创建一个GitLab OAuth应用程序。使用者密钥和使用者密钥用于授权访问GitLab资源</p><ul><li>授权回调URL必须与以下格式和路径匹配，并且必须使用确切的服务器方案和主机</li></ul><p>填写名称(name),回调地址(Redirect URI),勾选api与read_user权限</p><p><img src="/image/drone/gitlab_token_create.png"></p><p><img src="/image/drone/gitlab_token_created.png"></p><ul><li>配置gitlab出站请求</li></ul><p>gitlab 10.6 版本以后为了安全，不允许向本地网络发送webhook请求，如果想向本地网络发送webhook请求，则需要使用管理员帐号登录配置OutBound Request</p><p>使用管理员账号登录 setting &#x3D;&gt; network &#x3D;&gt; Outbound requests<br><img src="/image/drone/gitlab_settings.png"></p><p>Expand-勾选Allow requests to the local network from web hooks and services<br><img src="/image/drone/gitlab_network.png"></p><ul><li>创建共享秘密</li></ul><p>创建一个共享密钥，以验证runner与drone服务器之间的通信</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl rand -hex 16</span></span><br><span class="line">d065db69f7dcc35bd6a0658a9e8b4201</span><br></pre></td></tr></table></figure><h2 id="安装drone-server"><a href="#安装drone-server" class="headerlink" title="安装drone-server"></a>安装drone-server</h2><ul><li>pvc.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone-data</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure><ul><li>deploy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">drone</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">drone</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">drones</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">drone</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">drone-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">drone-data</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">drone-server</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;drone/drone:1.10.1&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_GITLAB_CLIENT_ID</span>       <span class="comment"># Gitlab Application ID</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">e4ea12c994c9084290a2237f8076db98bc5476058d70a699d01057c391e6e2f7</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_GITLAB_CLIENT_SECRET</span>   <span class="comment"># Gitlab Secret</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">575dabd93c02c09b95625fc4d11ae28d5e7f63d461c7b457a84d3a939c82339c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_RPC_SECRET</span>             <span class="comment"># 使用openssl rand -hex 16 创建的一个共享密钥，以验证runner与drone-server之间的通信</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">d065db69f7dcc35bd6a0658a9e8b4201</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_GITLAB_SERVER</span>          <span class="comment"># Gitlab服务器地址</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;http://10.166.33.116:19980&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_SERVER_HOST</span>            <span class="comment"># drone-server 服务地址</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;10.166.33.107:54839&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_SERVER_PROTO</span>           <span class="comment"># drone-server 协议，设置http或https</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">http</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_GITLAB</span>                 <span class="comment"># 使用gitlab</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_USER_CREATE</span>            <span class="comment"># 给gitlab用户授权为管理员</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;username:root,admin:true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_AGENTS_ENABLED</span>         <span class="comment"># 是否开启身份验证</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_LOGS_TRACE</span>             <span class="comment"># 打开日志</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">drone-data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># The service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone-server-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">drone</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">54839</span></span><br></pre></td></tr></table></figure><h2 id="安装drone-runner"><a href="#安装drone-runner" class="headerlink" title="安装drone-runner"></a>安装drone-runner</h2><p>drone启动并运行后，您将需要安装runner程序以执行构建管道</p><ul><li>rabc.yaml</li></ul><p>Kubernetes runner程序使用集群内ServiceAccount与Kubernetes API进行通信。在部署到集群时，请确保Kubernetes runner程序与ServiceAccount关联</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/log</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><ul><li>deploy.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">drone-runner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">drone</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">drone</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">drone</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">drone</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">drone</span>               </span><br><span class="line">      <span class="attr">containers:</span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">runner</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">drone/drone-runner-kube:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_RPC_HOST</span>               <span class="comment"># drone-server 服务地址</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&#x27;10.166.33.107:54839&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_RPC_PROTO</span>              <span class="comment"># drone-server 服务协议</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http</span>           </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DRONE_RPC_SECRET</span>             <span class="comment"># 使用openssl rand -hex 16 创建的一个共享密钥，以验证runner与drone-server之间的通信</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">d065db69f7dcc35bd6a0658a9e8b4201</span></span><br></pre></td></tr></table></figure><h2 id="Drone使用"><a href="#Drone使用" class="headerlink" title="Drone使用"></a>Drone使用</h2><ul><li>认证</li></ul><p>首先，在浏览器中导航到您的Drone服务器URL。如果您尚未通过身份验证，Drone会将您重定向到GitHub进行登录。<br>登录后，您将被重定向回您的Drone仪表板。如果这是您第一次使用Drone，则在Drone将您的存储库列表与GitHub同步时，您的仪表板将空几秒钟<br><img src="/image/drone/gitlab_auth.png"></p><ul><li>启用存储库</li></ul><p>搜索您的存储库，然后单击“启用”按钮。单击启用按钮，将向您的存储库添加一个Webhook，以便在每次推送代码时通知Drone。请注意，您必须对存储库具有管理员权限才能启用</p><p>代码仓库：<a href="https://github.com/wq-h/demo-2048.git">https://github.com/wq-h/demo-2048.git</a></p><p><img src="/image/drone/drone_enable.png"></p><p><img src="/image/drone/drone_settings.png"></p><ul><li>配置pipeline</li></ul><p>您需要通过.drone.yml在git存储库的根目录中创建一个文件来配置管道。在此文件中，我们定义了每次收到Webhook时都要执行的一系列步骤</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过验证证书，根据实际情况要或不要，github不需要</span></span><br><span class="line"><span class="attr">clone:</span></span><br><span class="line">  <span class="attr">skip_verify:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择pipeline跑在demo命名空间里</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># node选择</span></span><br><span class="line"><span class="attr">node_selector:</span></span><br><span class="line">  <span class="attr">kubernetes.io/hostname:</span> <span class="string">slave-14</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载本地目录</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/cache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一阶段：构建代码</span></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build</span> <span class="string">code</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">maven:3.6-jdk-8</span></span><br><span class="line">    <span class="comment"># 在容器里执行的shell命令列表  </span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">install</span> <span class="string">-DskipTests=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cd</span> <span class="string">target</span> <span class="string">&amp;&amp;</span> <span class="string">jar</span> <span class="string">-xf</span> <span class="number">2048.</span><span class="string">war</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ls</span> <span class="string">-l</span></span><br><span class="line">    <span class="comment"># 在容器里挂载目录</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/root/.m2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二阶段: 构建镜像&amp;推送镜像</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">build</span> <span class="string">image</span> <span class="string">&amp;</span> <span class="string">push</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">plugins/docker</span>     <span class="comment"># docker插件</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="comment"># 镜像仓库组名称</span></span><br><span class="line">      <span class="attr">repo:</span> <span class="number">10.166</span><span class="number">.33</span><span class="number">.110</span><span class="string">/demo/demo-2048</span></span><br><span class="line">      <span class="comment"># 镜像仓库名称</span></span><br><span class="line">      <span class="attr">registry:</span> <span class="number">10.166</span><span class="number">.33</span><span class="number">.110</span></span><br><span class="line">      <span class="comment"># 在web界面中设置的密钥        </span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">harbor_username</span>    </span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">harbor_password</span></span><br><span class="line">      <span class="comment"># 镜像tag定义</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;DRONE_BRANCH&#125;-$&#123;DRONE_COMMIT&#125;-$&#123;DRONE_BUILD_NUMBER&#125;</span></span><br><span class="line">      <span class="comment"># 启用非ssl加密</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 构建镜像的dockerfile文件</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">./Dockerfiles/Dockerfile</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三阶段: 服务滚动更新</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-deploy</span></span><br><span class="line">    <span class="comment"># Kubernetes插件</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">danielgormly/drone-plugin-kube:0.2.0</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">build_tag:</span> <span class="string">$&#123;DRONE_BRANCH&#125;-$&#123;DRONE_COMMIT&#125;-$&#123;DRONE_BUILD_NUMBER&#125;</span></span><br><span class="line">      <span class="comment"># yaml模板</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">template/demo-2048.yaml</span></span><br><span class="line">      <span class="comment"># apiserver地址    </span></span><br><span class="line">      <span class="attr">server:</span> <span class="string">https://10.166.33.111:6443</span></span><br><span class="line">      <span class="comment"># Kubernetes服务帐户令牌 &#x27;kubectl get secret -nkube-system|grep token&#x27;</span></span><br><span class="line">      <span class="attr">token:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">k8s_token</span></span><br><span class="line">      <span class="comment"># K8s CA证书的Base-64编码的字符串</span></span><br><span class="line">      <span class="attr">ca:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">k8s_ca</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四阶段: 邮件通知</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">email</span></span><br><span class="line">    <span class="comment"># 邮件插件</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">drillster/drone-email:latest</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="comment"># 只发送给邮件收件人</span></span><br><span class="line">      <span class="attr">recipients_only:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 邮件收件列表</span></span><br><span class="line">      <span class="attr">recipients:</span> [<span class="string">weiqun_h@163.com</span>]</span><br><span class="line">      <span class="comment"># 设置主题</span></span><br><span class="line">      <span class="attr">subject:</span> <span class="string">&quot;Drone build: [<span class="template-variable">&#123;&#123; build.status &#125;&#125;</span>] <span class="template-variable">&#123;&#123; repo.name &#125;&#125;</span> (<span class="template-variable">&#123;&#123; repo.branch &#125;&#125;</span>) #<span class="template-variable">&#123;&#123; build.number &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 邮件服务器主机</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">smtp.exmail.qq.com</span></span><br><span class="line">      <span class="comment"># 邮件服务器端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">465</span></span><br><span class="line">      <span class="comment"># 从该地址发送通知</span></span><br><span class="line">      <span class="attr">from:</span> <span class="string">weiqun.he@tenxcloud.com</span></span><br><span class="line">      <span class="comment"># 用户名</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">email_user</span></span><br><span class="line">      <span class="comment"># 密码</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">        <span class="attr">from_secret:</span> <span class="string">email_password</span></span><br><span class="line">    <span class="comment"># 当流水线执行成功时失败是发送    </span></span><br><span class="line">    <span class="attr">when:</span></span><br><span class="line">      <span class="attr">status:</span> [ <span class="string">success</span>, <span class="string">failure</span> ]</span><br><span class="line">      </span><br><span class="line"><span class="comment"># 通过分支限制pipeline执行</span></span><br><span class="line"><span class="attr">trigger:</span></span><br><span class="line">  <span class="attr">branch:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">drone</span></span><br></pre></td></tr></table></figure><ul><li>根据应用类型创建资源模板</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-2048</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-2048</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">demo-2048</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">demo-2048</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">            10.166.33.110/demo/demo-2048:&#123;&#123;build_tag&#125;&#125;</span></span><br><span class="line"><span class="string"></span>          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">128m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">128m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor</span></span><br></pre></td></tr></table></figure><p>secret 配置</p><p><img src="/image/drone/drone_secret.png"></p><p>pipeline执行结果</p><p><img src="/image/drone/drone_success.png"></p><p>邮件通知<br><img src="/image/drone/drone_email.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;gitlab创建OAuth应用&quot;&gt;&lt;a href=&quot;#gitlab创建OAuth应用&quot; class=&quot;headerlink&quot; title=&quot;gitlab创建OAuth应用&quot;&gt;&lt;/a&gt;gitlab创建OAuth应用&lt;/h2&gt;&lt;p&gt;创建一个GitLab OAuth应用</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="drone" scheme="https://wqblogs.com/categories/Kubernetes/drone/"/>
    
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
    <category term="drone" scheme="https://wqblogs.com/tags/drone/"/>
    
  </entry>
  
  <entry>
    <title>k8s部署consul集群</title>
    <link href="https://wqblogs.com/2021/01/27/k8s%E9%83%A8%E7%BD%B2conusl/"/>
    <id>https://wqblogs.com/2021/01/27/k8s%E9%83%A8%E7%BD%B2conusl/</id>
    <published>2021-01-27T08:49:04.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><ul><li>consul.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim consul.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">consul</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">consul</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">consul</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">harbor</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/localtime</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">consul-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">        <span class="attr">image:</span> <span class="number">10.166</span><span class="number">.33</span><span class="number">.110</span><span class="string">/infra/consul:1.9.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;agent&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-server&quot;</span>                  <span class="comment"># 以server加入集群</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-bootstrap-expect=3&quot;</span>      <span class="comment"># 组成集群预期需要的数量</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-config-dir=/etc/consul/config&quot;</span>                     <span class="comment">#配置文件目录，所有以.json结尾的文件都会被加载，可以是服务或consul自身的配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-advertise=$(PODIP)&quot;</span>      <span class="comment"># 节点地址</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local&quot;</span>   <span class="comment"># 对已知地址情况下，启动时加入的另一位代理的地址</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/consul/data</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-time</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/consul/config</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PODIP</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAMESPACE</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8500</span>     <span class="comment"># HTTP API 及 Web UI</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8300</span>     <span class="comment">#  Server RPC，server 用于接受其他 agent 的请求</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8301</span>     <span class="comment"># Serf LAN，数据中心内 gossip 交换数据用</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">serflan</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8302</span>     <span class="comment"># Serf WAN，跨数据中心 gossip 交换数据用</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">serfwan</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8400</span>     <span class="comment"># CLI RPC，接受命令行的 RPC 调用</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">cli-port</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8600</span>     <span class="comment"># DNS 服务，可以把它配置到 53 端口来响应 dns 请求</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">consuldns</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure><ul><li>headless.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8300</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8300</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serflan-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">&quot;TCP&quot;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8301</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8301</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serflan-udp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">&quot;UDP&quot;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8301</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8301</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serfwan-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">&quot;TCP&quot;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8302</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8302</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serfwan-udp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">&quot;UDP&quot;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8302</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8302</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cli-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8400</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8400</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consuldns</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8600</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8600</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">consul</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">consul-web</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8500</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8300</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8300</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serflan-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8301</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8301</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serflan-udp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8301</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8301</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serfwan-tcp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8302</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8302</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serfwan-udp</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8302</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8302</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cli-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8400</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8400</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consuldns</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8600</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8600</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">consul</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><ul><li>config.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">consul-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">server.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;bind_addr&quot;: &quot;0.0.0.0&quot;,           // 应为内部集群通信绑定的地址</span></span><br><span class="line"><span class="string">      &quot;client_addr&quot;: &quot;0.0.0.0&quot;,         // consul绑定客户端接口的地址</span></span><br><span class="line"><span class="string">      &quot;disable_host_node_id&quot;: true,     // 将此设置为true将阻止Consul使用来自主机的信息生成确定性节点标识，并将生成随机节点标识，该标识将保留在数据目录中</span></span><br><span class="line"><span class="string">      &quot;data_dir&quot;: &quot;/consul/data&quot;,       // consul持久化数据存储位置</span></span><br><span class="line"><span class="string">      &quot;datacenter&quot;: &quot;shisuyun&quot;,         // 数据中心名称</span></span><br><span class="line"><span class="string">      &quot;bootstrap_expect&quot;: 3,            // 组成集群预期需要的数量</span></span><br><span class="line"><span class="string">      &quot;server&quot;: true,                   // 表示当前使用的server模式</span></span><br><span class="line"><span class="string">      &quot;domain&quot;: &quot;cluster.consul&quot;,       // 默认情况下，Consul响应&quot;consul&quot;中的DNS查询</span></span><br><span class="line"><span class="string">      &quot;retry_join&quot;: [                   // k8s集群</span></span><br><span class="line"><span class="string">        &quot;provider=k8s namespace=demo label_selector=\&quot;app=consul,component=server\&quot;&quot;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;telemetry&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;prometheus_retention_time&quot;: &quot;5m&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">ui.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;ui&quot; : true,                      // 启用内置的Web UI服务器和所需的HTTP路由</span></span><br><span class="line"><span class="string">      &quot;client_addr&quot; : &quot;0.0.0.0&quot;,</span></span><br><span class="line"><span class="string">      &quot;enable_script_checks&quot; : false,</span></span><br><span class="line"><span class="string">      &quot;disable_remote_exec&quot; : true</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure><h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f headless.yaml</span></span><br><span class="line">service/consul created</span><br><span class="line">service/consul-web created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f config.yaml</span></span><br><span class="line">configmap/consul-config  created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f consul.yaml</span></span><br><span class="line">statefulset.apps/consul created</span><br></pre></td></tr></table></figure><p><img src="https://www.wqblogs.com:4443/image/k8s-consul.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;准备资源配置清单&quot;&gt;&lt;a href=&quot;#准备资源配置清单&quot; class=&quot;headerlink&quot; title=&quot;准备资源配置清单&quot;&gt;&lt;/a&gt;准备资源配置清单&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;consul.yaml&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;hi</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="consul" scheme="https://wqblogs.com/categories/Kubernetes/consul/"/>
    
    
    <category term="consul" scheme="https://wqblogs.com/tags/consul/"/>
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>k8s对接nfs存储</title>
    <link href="https://wqblogs.com/2021/01/27/k8s%E5%AF%B9%E6%8E%A5nfs%E5%AD%98%E5%82%A8/"/>
    <id>https://wqblogs.com/2021/01/27/k8s%E5%AF%B9%E6%8E%A5nfs%E5%AD%98%E5%82%A8/</id>
    <published>2021-01-27T08:30:04.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>nfs-client-provisioner,它可以使用现有的和已配置的NFS服务器来通过持久卷声明来动态供应Kubernetes持久卷<br>使用<a href="https://github.com/kubernetes-sigs/sig-storage-lib-external-provisioner">sig-storage-lib-external-provisioner</a>的开发<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">nfs-subdir-external-provisioner</a>进行配置</p><h2 id="安装nfs"><a href="#安装nfs" class="headerlink" title="安装nfs"></a>安装nfs</h2><p>每个slave节点安装nfs</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install -y nfs-utils</span></span><br></pre></td></tr></table></figure><h2 id="安装storage-class"><a href="#安装storage-class" class="headerlink" title="安装storage class"></a>安装storage class</h2><h2 id="准备资源清单"><a href="#准备资源清单" class="headerlink" title="准备资源清单"></a>准备资源清单</h2><ul><li>rbac</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><ul><li>deploy</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span>  <span class="comment"># provisioner的名字，需要和StorageClass对象中的provisioner字段一致</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">shisuyun/nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.28</span><span class="number">.17</span>  <span class="comment"># NFS服务器地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span>       </span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs/volume</span>    <span class="comment"># NFS服务器目录</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.28</span><span class="number">.17</span>   <span class="comment"># NFS服务器地址</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs/volume</span>       <span class="comment"># NFS服务器目录</span></span><br></pre></td></tr></table></figure><ul><li>class</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">shisuyun/nfs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure><h2 id="创建资源清单"><a href="#创建资源清单" class="headerlink" title="创建资源清单"></a>创建资源清单</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f rbac.yaml</span></span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br><span class="line">role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f deploy.yaml</span></span><br><span class="line">deployment.apps/nfs-client-provisioner created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f class.yaml</span></span><br><span class="line">storageclass.storage.k8s.io/nfs created</span><br></pre></td></tr></table></figure><h2 id="测试创建pv"><a href="#测试创建pv" class="headerlink" title="测试创建pv"></a>测试创建pv</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim pvc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-test</span><br><span class="line">  namespace: demo</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line">  storageClassName: nfs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f pvc.yaml</span></span><br><span class="line">persistentvolumeclaim/nfs-test created</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pv</span></span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-c702ccbb-eddd-445f-ab86-efb44769c1d4   5Gi        RWX            Delete           Bound       demo/nfs-test   nfs                     7s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pvc -ndemo</span></span><br><span class="line">NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">nfs-test   Bound    pvc-c702ccbb-eddd-445f-ab86-efb44769c1d4   5Gi        RWX            nfs            25s</span><br></pre></td></tr></table></figure><h2 id="1-20新版本问题"><a href="#1-20新版本问题" class="headerlink" title="1.20新版本问题"></a>1.20新版本问题</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">I0218 10:05:03.223179       1 leaderelection.go:194] successfully acquired lease kube-system/shisuyun-nfs</span><br><span class="line">I0218 10:05:03.223336       1 controller.go:631] Starting provisioner controller shisuyun/nfs_nfs-client-provisioner-6db9db9dcf-c6phr_ba4b22b4-71d0-11eb-82ab-12d5aefc2432!</span><br><span class="line">I0218 10:05:03.324107       1 controller.go:680] Started provisioner controller shisuyun/nfs_nfs-client-provisioner-6db9db9dcf-c6phr_ba4b22b4-71d0-11eb-82ab-12d5aefc2432!</span><br><span class="line">I0218 10:05:03.324440       1 controller.go:987] provision &quot;mysql/nfs-test&quot; class &quot;nfs&quot;: started</span><br><span class="line">E0218 10:05:03.332013       1 controller.go:1004] provision &quot;mysql/nfs-test&quot; class &quot;nfs&quot;: unexpected error getting claim reference: selfLink was empty, can&#x27;t make reference</span><br></pre></td></tr></table></figure><p><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/issues/25">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/issues/25</a></p><p>在&#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml配置添加参数</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">- --feature-gates=RemoveSelfLink=false</span><br></pre></td></tr></table></figure><p>保存之后重新创建pvc</p><p>可以直接使用k8s.gcr.io&#x2F;sig-storage&#x2F;nfs-subdir-external-provisioner:v4.0.2 避免修改api-server；<br>国内镜像：registry.cn-hangzhou.aliyuncs.com&#x2F;hwq-infra&#x2F;nfs-client-provisioner:v4.0.2</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;nfs-client-provisioner,它可以使用现有的和已配置的NFS服务器来通过持久卷声明来动态供应Kubernetes持久卷&lt;br&gt;使用&lt;a href=&quot;https://github.com/kubernetes-sigs/sig-storage-lib-ext</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="nfs" scheme="https://wqblogs.com/categories/Kubernetes/nfs/"/>
    
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
    <category term="nfs" scheme="https://wqblogs.com/tags/nfs/"/>
    
  </entry>
  
  <entry>
    <title>jenkins流水线pipeline使用</title>
    <link href="https://wqblogs.com/2021/01/23/jenkins%E6%B5%81%E6%B0%B4%E7%BA%BFpipeline/"/>
    <id>https://wqblogs.com/2021/01/23/jenkins%E6%B5%81%E6%B0%B4%E7%BA%BFpipeline/</id>
    <published>2021-01-23T11:56:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="gitlab配置公钥"><a href="#gitlab配置公钥" class="headerlink" title="gitlab配置公钥"></a>gitlab配置公钥</h2><p>代码仓库：代码仓库：<a href="https://github.com/wq-h/demo-2048.git">https://github.com/wq-h/demo-2048.git</a></p><p>创建密钥</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssh-keygen -t rsa -b 2048 -C <span class="string">&quot;weiqun_h@163.com&quot;</span> -N <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:lo1dX2Kj+5Z8n7LiICLc9yYJdkhlY9W2YpNsTn/pmrI weiqun_h@163.com</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|        ...      |</span><br><span class="line">|       =   o     |</span><br><span class="line">|      + o o o + .|</span><br><span class="line">|     .   &amp; o + + |</span><br><span class="line">|    . . S * . o  |</span><br><span class="line">|  . .+ o . . +   |</span><br><span class="line">|   o.ooo..  +. . |</span><br><span class="line">|    . oooo...++ o|</span><br><span class="line">|        oE++oo+oo|</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure><p>gitlab配置公钥<br><img src="/image/gitlab_key.png"></p><h2 id="jenkins-创建凭据"><a href="#jenkins-创建凭据" class="headerlink" title="jenkins 创建凭据"></a>jenkins 创建凭据</h2><p>选择ssh username with private key类型  添加私钥<br><img src="/image/jenkins_key.png"></p><h2 id="jenkins配置流水线"><a href="#jenkins配置流水线" class="headerlink" title="jenkins配置流水线"></a>jenkins配置流水线</h2><ul><li>创建项目</li></ul><p><img src="/image/jenkins_pipeline.png"></p><ul><li>配置流水线</li></ul><p><img src="/image/jenkins_scripts.png"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any                                         // 可以在任何可用的代理上执行pipeline或stage</span><br><span class="line">    environment &#123;                                     // 指令指定一系列键值对，这些键值对将被定义为所有step或特定stage的step的环境变量</span><br><span class="line">      GIT_REPO=&quot;https://gitlub.com/wq-h/demo-2048.git&quot; // 构建项目的git仓库地址</span><br><span class="line">      GIT_BRANCH=&quot;master&quot;                             // 构建项目的git分支</span><br><span class="line">      SSH_ID=&quot;51561e93-8c3c-4904-8fce-2c0014c5dc9f&quot;   // Jenkins里配置ssh key的唯一标识</span><br><span class="line">      MVN_CMD=&quot;mvn clean package &amp;&amp; cd target &amp;&amp; jar -xf 2048.war&quot;                     // maven编译命令</span><br><span class="line">      TARGET_DIR=&quot;target&quot;                             // 编译项目输出jar或war包的路径</span><br><span class="line">      BASE_IMAGE=&quot;harbor.od.com/system_containers/tomcat:v8.0&quot;  // Dockerfile底层镜像</span><br><span class="line">      Repository=&quot;harbor.od.com/infra&quot;                           // docker仓库组</span><br><span class="line">      IMAGE_NAME=&quot;demo-2048&quot;                                    // 构建镜像的镜像名称</span><br><span class="line">      IMAGE_TAG=&quot;$&#123;BUILD_TIMESTAMP&#125;&quot;                            // 构建时的时间，为构建镜像的tag</span><br><span class="line">      NAMESPACE=&quot;demo&quot;                                     // 更新服务时的namespace</span><br><span class="line">      DEPLOY=&quot;demo-2048&quot;                                  // 更新服务时deploy的名称</span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;                   // 在pipeline内只容许出现只有一次</span><br><span class="line">        stage(&#x27;检出代码&#x27;) &#123;    // 阶段，pipeline 工作所在的位置</span><br><span class="line">            steps &#123;            // 步骤，在stage指令中执行的一个或多个步骤</span><br><span class="line">                deleteDir()    // 递归删除WORKSPACE下的文件和文件夹</span><br><span class="line">                checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &quot;*/$&#123;GIT_BRANCH&#125;&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;$&#123;SSH_ID&#125;&quot;, url: &quot;$&#123;GIT_REPO&#125;&quot;]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;构建代码&#x27;) &#123;</span><br><span class="line">            tools &#123;                                    // 定义自动安装和放置工具的部分PATH</span><br><span class="line">                maven &quot;apache-maven-3.6.3&quot;             // 工具名称必须在Jenkins 管理Jenkins → 全局工具配置中预置</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &quot;$&#123;MVN_CMD&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            post &#123;             // post定义将在pipeline运行或stage结束时运行的操作</span><br><span class="line">                success &#123;      // 成功之后提取制品</span><br><span class="line">                     archiveArtifacts &quot;$&#123;TARGET_DIR&#125;/*.war&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;构建镜像&#x27;) &#123;</span><br><span class="line">             steps &#123;          // 创建Dockerfile并构建</span><br><span class="line">                 writeFile file: &quot;$&#123;TARGET_DIR&#125;/Dockerfile&quot;, text: &quot;&quot;&quot;FROM $&#123;BASE_IMAGE&#125;</span><br><span class="line">                                                              COPY ./*.war /usr/local/tomcat/webapps&quot;&quot;&quot;</span><br><span class="line">                 sh &quot;cd ./target &amp;&amp; docker build -t $&#123;Repository&#125;/$&#123;IMAGE_NAME&#125;:$&#123;IMAGE_TAG&#125; .&quot;</span><br><span class="line">              &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;推送镜像&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                 sh &quot;docker push $&#123;Repository&#125;/$&#123;IMAGE_NAME&#125;:$&#123;IMAGE_TAG&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;更新服务&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                //sh &quot;kubectl get po -A&quot;</span><br><span class="line">                sh &quot;kubectl set image deploy/$&#123;DEPLOY&#125; $&#123;DEPLOY&#125;=$&#123;Repository&#125;/$&#123;IMAGE_NAME&#125;:$&#123;IMAGE_TAG&#125; -n$&#123;NAMESPACE&#125; &quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/image/jenkins_work.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;gitlab配置公钥&quot;&gt;&lt;a href=&quot;#gitlab配置公钥&quot; class=&quot;headerlink&quot; title=&quot;gitlab配置公钥&quot;&gt;&lt;/a&gt;gitlab配置公钥&lt;/h2&gt;&lt;p&gt;代码仓库：代码仓库：&lt;a href=&quot;https://github.com/</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="jenkins" scheme="https://wqblogs.com/categories/Kubernetes/jenkins/"/>
    
    
    <category term="jenkins" scheme="https://wqblogs.com/tags/jenkins/"/>
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>jenkins集成k8s</title>
    <link href="https://wqblogs.com/2021/01/23/jenkins%E9%9B%86%E6%88%90k8s/"/>
    <id>https://wqblogs.com/2021/01/23/jenkins%E9%9B%86%E6%88%90k8s/</id>
    <published>2021-01-23T11:16:49.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="jenkins集成k8s集群"><a href="#jenkins集成k8s集群" class="headerlink" title="jenkins集成k8s集群"></a>jenkins集成k8s集群</h2><ul><li>创建证书</li></ul><p>打开~&#x2F;.kube&#x2F;config文件<br><img src="/image/k8s_config.png"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">复制certificate-authority-data的内容，运行以下命令生成client.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;certificate-authority-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; ca.crt</span></span><br><span class="line">复制client-certificate-data的内容，运行以下命令生成client.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;client-certificate-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; client.crt</span></span><br><span class="line">复制client-key-data的内容，运行以下命令生成client.key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;&lt;client-key-data&gt;&quot;</span> | <span class="built_in">base64</span> -d &gt; client.key</span></span><br><span class="line"></span><br><span class="line">再根据前面步骤生成的ca.crt, client.crt和client.key来生成PKCS12格式的cert.pfx</span><br><span class="line">以下命令运行时，需要输入4位以上的密码</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl pkcs12 -<span class="built_in">export</span> -out cert.pfx -inkey client.key -<span class="keyword">in</span> client.crt -certfile ca.crt</span></span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure><ul><li>jenkins创建证书凭证</li></ul><p><img src="/image/jenkins_cert.png"></p><ul><li>集成k8s</li></ul><p>选择系统管理 &#x3D;&gt; 系统配置 &#x3D;&gt; Cloud &#x3D;&gt; 点击a separate configuration page.<br>点击连接测试,如出现success(老版本)或者Connected to Kubernetes v1.X.X,表示连接k8s集群成功<br><img src="/image/jenkins_cloud.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;jenkins集成k8s集群&quot;&gt;&lt;a href=&quot;#jenkins集成k8s集群&quot; class=&quot;headerlink&quot; title=&quot;jenkins集成k8s集群&quot;&gt;&lt;/a&gt;jenkins集成k8s集群&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;创建证书&lt;/li&gt;
&lt;/ul&gt;
</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://wqblogs.com/categories/Kubernetes/"/>
    
    <category term="jenkins" scheme="https://wqblogs.com/categories/Kubernetes/jenkins/"/>
    
    
    <category term="jenkins" scheme="https://wqblogs.com/tags/jenkins/"/>
    
    <category term="kubernetes" scheme="https://wqblogs.com/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>配置yum仓库</title>
    <link href="https://wqblogs.com/2021/01/20/yum/"/>
    <id>https://wqblogs.com/2021/01/20/yum/</id>
    <published>2021-01-20T13:19:37.000Z</published>
    <updated>2023-06-24T15:59:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="使用centos镜像作为yum源"><a href="#使用centos镜像作为yum源" class="headerlink" title="使用centos镜像作为yum源"></a>使用centos镜像作为yum源</h3><p>挂载iso镜像至mnt目录</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mount -o loop /root/CentOS-7-x86_64-Everything-2009.iso /mnt</span></span><br><span class="line">mount: /dev/loop0 is write-protected, mounting read-only</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ll /mnt/</span></span><br><span class="line">total 1668</span><br><span class="line">-rw-r--r--.  1 root root      14 Oct 30 05:14 CentOS_BuildTag</span><br><span class="line">drwxr-xr-x.  3 root root    2048 Oct 27 00:25 EFI</span><br><span class="line">-rw-rw-r--. 17 root root     227 Aug 30  2017 EULA</span><br><span class="line">-rw-rw-r--. 17 root root   18009 Dec 10  2015 GPL</span><br><span class="line">drwxr-xr-x.  3 root root    2048 Oct 27 00:26 images</span><br><span class="line">drwxr-xr-x.  2 root root    2048 Oct 27 00:25 isolinux</span><br><span class="line">drwxr-xr-x.  2 root root    2048 Oct 27 00:25 LiveOS</span><br><span class="line">drwxr-xr-x.  2 root root 1669120 Oct 29 22:39 Packages</span><br><span class="line">drwxr-xr-x.  2 root root    4096 Oct 30 04:03 repodata</span><br><span class="line">-rw-rw-r--. 17 root root    1690 Dec 10  2015 RPM-GPG-KEY-CentOS-7</span><br><span class="line">-rw-rw-r--. 15 root root    1690 Dec 10  2015 RPM-GPG-KEY-CentOS-Testing-7</span><br><span class="line">-r--r--r--.  1 root root    2883 Nov  2 23:15 TRANS.TBL</span><br></pre></td></tr></table></figure><p>备份现有镜像repo源</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /etc/yum.repos.d/bak -p &amp;&amp; <span class="built_in">mv</span> /etc/yum.repos.d/*.repo /etc/yum.repos.d/bak/</span></span><br></pre></td></tr></table></figure><p>创建yum源repo文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim /etc/yum.repos.d/local.repo</span></span><br><span class="line">[Centos-7.9]</span><br><span class="line">name=local-repo</span><br><span class="line">baseurl=file:///mnt</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum clean all</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Cleaning repos: Centos-7.9</span><br></pre></td></tr></table></figure><h3 id="ftp配置yum源"><a href="#ftp配置yum源" class="headerlink" title="ftp配置yum源"></a>ftp配置yum源</h3><p>安装ftp</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install -y vsftpd</span></span><br></pre></td></tr></table></figure><p>挂载iso镜像至ftp共享目录</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> /var/ftp/centos7.9</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> -rf /mnt/* /var/ftp/centos7.9/</span></span><br></pre></td></tr></table></figure><p>启动ftp</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl <span class="built_in">enable</span> vsftpd</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl start vsftpd</span></span><br></pre></td></tr></table></figure><p>卸载mnt目录</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">umount /mnt</span></span><br></pre></td></tr></table></figure><p>配置yum源repo文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Centos-7.9]</span><br><span class="line">name=local-repo</span><br><span class="line">baseurl=ftp://192.168.1.100/centos7.9</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=ftp://192.168.1.100/centos7.9/RPM-GPG-KEY-CentOS-7</span><br></pre></td></tr></table></figure><p>验证yum源</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum repolist</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Centos-7.9                                                                                                 | 3.6 kB  00:00:00     </span><br><span class="line">(1/2): Centos-7.9/group_gz                                                                                 | 153 kB  00:00:00     </span><br><span class="line">(2/2): Centos-7.9/primary_db                                                                               | 6.1 MB  00:00:00     </span><br><span class="line">repo id                                                       repo name                                                     status</span><br><span class="line">Centos-7.9                                                    local-repo                                                    10,072</span><br><span class="line">repolist: 10,072</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;使用centos镜像作为yum源&quot;&gt;&lt;a href=&quot;#使用centos镜像作为yum源&quot; class=&quot;headerlink&quot; title=&quot;使用centos镜像作为yum源&quot;&gt;&lt;/a&gt;使用centos镜像作为yum源&lt;/h3&gt;&lt;p&gt;挂载iso镜像至mnt目录&lt;</summary>
      
    
    
    
    <category term="linux基础" scheme="https://wqblogs.com/categories/linux%E5%9F%BA%E7%A1%80/"/>
    
    
  </entry>
  
</feed>
